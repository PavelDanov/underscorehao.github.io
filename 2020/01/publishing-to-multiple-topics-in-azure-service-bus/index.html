<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Pavel Danov">
    <meta name="description" content="Pavel Danov&#39;s personal website">
    <meta name="keywords" content="blog,developer,personal,back-end,c#,c&#43;&#43;,programming,software,tech,backend,fintech">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Publishing to Multiple Topics in Azure Service Bus"/>
<meta name="twitter:description" content="Multiple topics There are two main approaches when it comes to topics in Azure Service Bus. Depending what&#39;s your architecture and needs you can have either:
 Filtered topic - this means you have only one topic for all of your event types. All publishers push messages onto that single topic. Some of the message fields and properties are then used for filtering by the subscribers since in most cases a subscriber will be interested only in certain types of messages."/>

    <meta property="og:title" content="Publishing to Multiple Topics in Azure Service Bus" />
<meta property="og:description" content="Multiple topics There are two main approaches when it comes to topics in Azure Service Bus. Depending what&#39;s your architecture and needs you can have either:
 Filtered topic - this means you have only one topic for all of your event types. All publishers push messages onto that single topic. Some of the message fields and properties are then used for filtering by the subscribers since in most cases a subscriber will be interested only in certain types of messages." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.underscorehao.net/2020/01/publishing-to-multiple-topics-in-azure-service-bus/" />
<meta property="article:published_time" content="2020-01-11T19:33:48+00:00" />
<meta property="article:modified_time" content="2020-01-11T19:33:48+00:00" />


    
      <base href="https://www.underscorehao.net/2020/01/publishing-to-multiple-topics-in-azure-service-bus/">
    
    <title>
  Publishing to Multiple Topics in Azure Service Bus · _hao
</title>

    
      <link rel="canonical" href="https://www.underscorehao.net/2020/01/publishing-to-multiple-topics-in-azure-service-bus/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://www.underscorehao.net/css/coder.min.28d751104f30c16da1aa1bb04015cbe662cacfe0d1b01af4f2240ad58580069c.css" integrity="sha256-KNdREE8wwW2hqhuwQBXL5mLKz&#43;DRsBr08iQK1YWABpw=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="https://www.underscorehao.net/css/coder-dark.min.83a2010dac9f59f943b3004cd6c4f230507ad036da635d3621401d42ec4e2835.css" integrity="sha256-g6IBDayfWflDswBM1sTyMFB60DbaY102IUAdQuxOKDU=" crossorigin="anonymous" media="screen" />
      
    

    
      <link rel="stylesheet" href="https://www.underscorehao.net/css/custom.css" />
    
      <link rel="stylesheet" href="https://www.underscorehao.net/css/syntax.css" />
    

    

    

    <link rel="icon" type="image/png" href="https://www.underscorehao.net/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://www.underscorehao.net/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.62.2" />
  </head>

  
  
    
  
  <body class="colorscheme-dark">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://www.underscorehao.net/">
      _hao
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://www.underscorehao.net/posts/">Blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://www.underscorehao.net/about/">About</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://www.underscorehao.net/contact/">Contact</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Publishing to Multiple Topics in Azure Service Bus</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2020-01-11T19:33:48Z'>
                January 11, 2020
              </time>
            </span>
            <span class="reading-time">
              <i class="fas fa-clock"></i>
              6 minutes read
            </span>
          </div>
          
          
        </div>
      </header>

      <div>
        <h2 id="multiple-topics">Multiple topics</h2>
<p>There are two main approaches when it comes to topics in Azure Service Bus. Depending what's your architecture and needs you can have either:</p>
<ul>
<li><strong>Filtered topic</strong> - this means you have only one topic for all of your event types. All publishers push messages onto that single topic. Some of the message fields and properties are then used for filtering by the subscribers since in most cases a subscriber will be interested only in certain types of messages.</li>
<li><strong>Multiple topics</strong> - you have multiple topics for different domain events or channels of your system. You can still leverage the filtering to have more granular control in your subscribers. You can also have topics based on priority, event types etc.</li>
</ul>
<p>Our main concern in this post is the second use case and how to build a nice <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.servicebus.topicclient?view=azure-dotnet"><strong><code>ITopicClient</code></strong></a> factory inside a .NET Core project. I've built my example with Azure Functions, but 99.9% of the code is completely identical to what you would do in a normal .NET Core web service.</p>
<h2 id="basic-setup">Basic Setup</h2>
<p>If you haven't used <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.servicebus.topicclient?view=azure-dotnet"><strong><code>ITopicClient</code></strong></a> and Azure Service Bus I recommend you read the following two articles before continuing:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-quickstart-topics-subscriptions-portal">Create Azure Service Bus topics and subscriptions</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-dotnet-how-to-use-topics-subscriptions">Getting started with Service Bus topics</a></li>
</ul>
<p>Now that we know what libraries we'll be using we can start building our solution. The first step is to create our TopicClient which is easy enough</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">topicClient</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TopicClient</span><span class="p">(</span><span class="s">&#34;AzureServiceBusConnectionString&#34;</span><span class="p">,</span> <span class="s">&#34;TopicName&#34;</span><span class="p">)</span><span class="p">;</span>
</code></pre></div><p>The two things we need are the ASB connection string and the topic to which we would like to publish messages.</p>
<p>Let's get the boilerplate code that is going to be used onward out of the way first. You'll need to have something like that in your <code>appsettings.json</code> file</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;ServiceBus&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;Endpoint&#34;</span><span class="p">:</span> <span class="s2">&#34;AsbFooBarEndpoint&#34;</span><span class="p">,</span>
        <span class="nt">&#34;FooTopic&#34;</span><span class="p">:</span> <span class="s2">&#34;foo&#34;</span><span class="p">,</span>
        <span class="nt">&#34;BarTopic&#34;</span><span class="p">:</span> <span class="s2">&#34;bar&#34;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>And a simple POCO that you can map it to</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">ServiceBusOptions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Endpoint</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">FooTopic</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">BarTopic</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Then you register your options in the startup</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">void</span> <span class="n">BindConfigurationOptions</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">services</span><span class="p">.</span><span class="n">Configure</span><span class="p">&lt;</span><span class="n">ServiceBusOptions</span><span class="p">&gt;</span><span class="p">(</span><span class="n">options</span> <span class="p">=</span><span class="p">&gt;</span>
        <span class="n">Configuration</span><span class="p">.</span><span class="n">GetSection</span><span class="p">(</span><span class="s">&#34;ServiceBus&#34;</span><span class="p">)</span>
            <span class="p">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">options</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><h2 id="the-naïve-approach">The naïve approach</h2>
<p>If we were doing the first example (filtered topic) we are pretty much done. You can register your <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.servicebus.topicclient?view=azure-dotnet"><strong><code>ITopicClient</code></strong></a> as a <a href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-performance-improvements#reusing-factories-and-clients"><strong>singleton</strong></a> and inject it in your DI container.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="c1">// This is the Azure Functions host builder
</span><span class="c1"></span><span class="c1">// In a web service you&#39;ll have the IServiceCollection
</span><span class="c1"></span><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">Configure</span><span class="p">(</span><span class="n">IFunctionsHostBuilder</span> <span class="n">builder</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">ITopicClient</span><span class="p">&gt;</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">options</span> <span class="p">=</span> <span class="n">x</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IOptions</span><span class="p">&lt;</span><span class="n">ServiceBusOptions</span><span class="p">&gt;</span><span class="p">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">new</span> <span class="k">new</span> <span class="n">TopicClient</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">Endpoint</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">FooTopic</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>Finally you just use the injected client to send messages to the <code>Foo</code> topic</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="c1">// Code below uses a MediatR handler as an example
</span><span class="c1"></span><span class="k">public</span> <span class="k">class</span> <span class="nc">FooHandler</span> <span class="p">:</span> <span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ITopicClient</span> <span class="n">topicClient</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">FooHandler</span><span class="p">(</span><span class="n">ITopicClient</span> <span class="n">topicClient</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">topicClient</span> <span class="p">=</span> <span class="n">topicClient</span> <span class="p">?</span><span class="p">?</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">ArgumentNullException</span><span class="p">(</span><span class="n">nameof</span><span class="p">(</span><span class="n">topicClient</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">Handle</span><span class="p">(</span><span class="n">Foo</span> <span class="n">request</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="p">=</span><span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">ArgumentNullException</span><span class="p">(</span><span class="n">nameof</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

        <span class="k">try</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="n">topicClient</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">Message</span><span class="p">)</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>And that's that. We're done.</p>
<p>What happens however if we have to accommodate multiple topics? Do we inject multiple topics in the service/handler? Depending on your DI container are you even able to put multiple implementations of the same interface? Do we use a bunch of if statements and introduce cyclomatic complexity for deciding which topic client we want? These are all viable questions and solutions, but one elegant answer is hidden in the next section.</p>
<h2 id="introducing-the-itopicclient-resolver">Introducing the ITopicClient resolver</h2>
<p>In order to solve the problem at hand I want to minimize the complexity of dealing with multiple topics. I want the usage to be as simple as when using only one just like in the previous example. So how do we do that?</p>
<p>The first part of the problem is how to differentiate between the topic clients for each topic. We can do that by creating small wrapper classes around each client we have.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">FooClient</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">readonly</span> <span class="n">ITopicClient</span> <span class="n">TopicClient</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">FooClient</span><span class="p">(</span><span class="n">IOptions</span><span class="p">&lt;</span><span class="n">ServiceBusOptions</span><span class="p">&gt;</span> <span class="n">options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">TopicClient</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TopicClient</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">Endpoint</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">FooTopic</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">BarClient</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">readonly</span> <span class="n">ITopicClient</span> <span class="n">TopicClient</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">BarClient</span><span class="p">(</span><span class="n">IOptions</span><span class="p">&lt;</span><span class="n">ServiceBusOptions</span><span class="p">&gt;</span> <span class="n">options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">TopicClient</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TopicClient</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">Endpoint</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">BarTopic</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Now that we have our clients we are going to create a factory with the help of a <code>delegate</code>. Based on a <code>key</code> we'll return the exact topic client we want when we want it!</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">Microsoft.Azure.ServiceBus</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">FooBarApp.Clients</span>
<span class="p">{</span>
    <span class="c1">// The key can be a string, Type, enum, int - whatever you need really
</span><span class="c1"></span>    <span class="k">public</span> <span class="k">delegate</span> <span class="n">ITopicClient</span> <span class="n">TopicResolver</span><span class="p">(</span><span class="kt">string</span> <span class="n">key</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>The step where the magic happens is in our DI registration.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="c1">// This is the Azure Functions host builder
</span><span class="c1"></span><span class="c1">// In a web service you&#39;ll have the IServiceCollection
</span><span class="c1"></span><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">Configure</span><span class="p">(</span><span class="n">IFunctionsHostBuilder</span> <span class="n">builder</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">FooClient</span><span class="p">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
    <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">BarClient</span><span class="p">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
    <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">TopicResolver</span><span class="p">&gt;</span><span class="p">(</span><span class="n">topicProvider</span> <span class="p">=</span><span class="p">&gt;</span> <span class="n">key</span> <span class="p">=</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="c1">// The key can be a string, Type, enum, int - whatever you need really
</span><span class="c1"></span>        <span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">case</span> <span class="s">&#34;Foo&#34;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">topicProvider</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">FooClient</span><span class="p">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="n">TopicClient</span><span class="p">;</span>
            <span class="k">case</span> <span class="s">&#34;Bar&#34;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">topicProvider</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">BarClient</span><span class="p">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="n">TopicClient</span><span class="p">;</span>
            <span class="k">default</span><span class="p">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">KeyNotFoundException</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>Let's me explain what's happening here. First we're registering our named clients as <a href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-performance-improvements#reusing-factories-and-clients"><strong>singletons</strong></a> per the explanations and reasoning given in the documentation.</p>
<p>Next we register our <code>delegate</code> as a transient service that will return one of the topic clients we already registered based on a <code>key</code>. For my usage I use a <code>string</code> key stored inside the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.servicebus.message.userproperties?view=azure-dotnet#Microsoft_Azure_ServiceBus_Message_UserProperties">message user properties</a>. Your <code>key</code> can be anything like <code>int</code>, <code>enum</code> or a specific <code>Type</code>.</p>
<p>Last thing we have to do is to put our <code>TopicResolver</code> to work!</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="c1">// Code below uses a MediatR handler as an example
</span><span class="c1"></span><span class="k">public</span> <span class="k">class</span> <span class="nc">MessageHandler</span> <span class="p">:</span> <span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">Message</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">TopicResolver</span> <span class="n">topicResolver</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">MessageHandler</span><span class="p">(</span><span class="n">TopicResolver</span> <span class="n">topicResolver</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">topicResolver</span> <span class="p">=</span> <span class="n">topicResolver</span> <span class="p">?</span><span class="p">?</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">ArgumentNullException</span><span class="p">(</span><span class="n">nameof</span><span class="p">(</span><span class="n">topicResolver</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">Handle</span><span class="p">(</span><span class="n">Message</span> <span class="n">msg</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="p">=</span><span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">ArgumentNullException</span><span class="p">(</span><span class="n">nameof</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

        <span class="k">try</span>
        <span class="p">{</span>
             <span class="c1">// Use a field from the user properties of the message as key
</span><span class="c1"></span>             <span class="c1">// The client we get can be either FooClient or BarClient based on the value
</span><span class="c1"></span>            <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">topicResolver</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">UserProperties</span><span class="p">[</span><span class="s">&#34;Key&#34;</span><span class="p">]</span><span class="p">)</span><span class="p">;</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="p">;</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>As a bonus here's how to test if the <code>delegate</code> is doing it's job and verifying that the right client is called.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">AutoFixture</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Azure.ServiceBus</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Moq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Shouldly</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Xunit</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">FooBarApp.Tests</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MessageHandlerTests</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">TopicResolver</span><span class="p">&gt;</span> <span class="n">topicResolver</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">Fixture</span> <span class="n">fixture</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">Message</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">sut</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">MessageHandlerTests</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">topicResolver</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">TopicResolver</span><span class="p">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
            <span class="n">fixture</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Fixture</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
<span class="na">
</span><span class="na">        [Fact]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">Handle_ValidMessageRequest_Foo_SendsMessage</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="n">fixture</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">Message</span><span class="p">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
            <span class="c1">// Best will be to create a customizer for different Messages
</span><span class="c1"></span>            <span class="n">message</span><span class="p">.</span><span class="n">UserProperties</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">&#34;Key&#34;</span><span class="p">,</span> <span class="s">&#34;Foo&#34;</span><span class="p">)</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">ITopicClient</span><span class="p">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

            <span class="n">topicResolver</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span><span class="p">&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">)</span>
                <span class="p">.</span><span class="n">Returns</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">Object</span><span class="p">)</span><span class="p">;</span>

            <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MessageHandler</span><span class="p">(</span><span class="n">topicResolver</span><span class="p">.</span><span class="n">Object</span><span class="p">)</span><span class="p">;</span>

            <span class="k">await</span> <span class="n">sut</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="k">default</span><span class="p">)</span><span class="p">;</span>

            <span class="n">topicResolver</span><span class="p">.</span><span class="n">Verify</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span><span class="p">&gt;</span> <span class="n">x</span><span class="p">(</span><span class="s">&#34;Foo&#34;</span><span class="p">)</span><span class="p">,</span> <span class="n">Times</span><span class="p">.</span><span class="n">Once</span><span class="p">)</span><span class="p">;</span>
            <span class="n">client</span><span class="p">.</span><span class="n">Verify</span><span class="p">(</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span><span class="p">&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="n">Message</span><span class="p">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">)</span><span class="p">,</span> <span class="n">Times</span><span class="p">.</span><span class="n">Once</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
<span class="na">
</span><span class="na">        [Fact]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">Handle_ValidMessageRequest_Bar_SendsMessage</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="n">fixture</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">Message</span><span class="p">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
            <span class="c1">// Best will be to create a customizer for different Messages
</span><span class="c1"></span>            <span class="n">message</span><span class="p">.</span><span class="n">UserProperties</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">&#34;Key&#34;</span><span class="p">,</span> <span class="s">&#34;Bar&#34;</span><span class="p">)</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">ITopicClient</span><span class="p">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

            <span class="n">topicResolver</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span><span class="p">&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">)</span>
                <span class="p">.</span><span class="n">Returns</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">Object</span><span class="p">)</span><span class="p">;</span>

            <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MessageHandler</span><span class="p">(</span><span class="n">topicResolver</span><span class="p">.</span><span class="n">Object</span><span class="p">)</span><span class="p">;</span>

            <span class="k">await</span> <span class="n">sut</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="k">default</span><span class="p">)</span><span class="p">;</span>

            <span class="n">topicResolver</span><span class="p">.</span><span class="n">Verify</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span><span class="p">&gt;</span> <span class="n">x</span><span class="p">(</span><span class="s">&#34;Bar&#34;</span><span class="p">)</span><span class="p">,</span> <span class="n">Times</span><span class="p">.</span><span class="n">Once</span><span class="p">)</span><span class="p">;</span>
            <span class="n">client</span><span class="p">.</span><span class="n">Verify</span><span class="p">(</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span><span class="p">&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="n">Message</span><span class="p">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">)</span><span class="p">,</span> <span class="n">Times</span><span class="p">.</span><span class="n">Once</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>And that's it! With this setup now you can add multiple topic clients with ease! Hope you find this post useful. There are other ways to accomplish the same thing and solve this problem, but I like this approach because it's extremely clean, elegant and testable!</p>

      </div>

      <footer>
        


        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "underscorehao" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        
        
      </footer>
    </article>

    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
    
      
        © 2020
      
       Pavel Danov 
    
    
       · 
      Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
    
    
  </section>
</footer>

    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-106583563-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


  </body>

</html>
