<!DOCTYPE html>
<html
  dir="ltr"
  lang="en"
  data-theme=""
><head>
  <title>
    
      
        Publishing to Multiple Topics in Azure Service Bus |

      
      _hao


    
  </title>

  
  <meta charset="utf-8" /><meta name="generator" content="Hugo 0.80.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta
    name="description"
    content="
      Life and Tech


    "
  />
  
  
  
  <link
    rel="stylesheet"
    href="https://underscorehao.net/css/main.min.12d773253f877f9142c19e60bce96350408821d5e4fbf86768a737186ce79ea7.css"
    integrity="sha256-EtdzJT&#43;Hf5FCwZ5gvOljUECIIdXk&#43;/hnaKc3GGznnqc="
    crossorigin="anonymous"
    type="text/css"
  />
  
  
  <link
    rel="stylesheet"
    href="https://underscorehao.net/css/markupHighlight.min.8f07fad4abedfd5eb1396c6fef85ba7ec00ec867a79fb545c9db18df87f6760a.css"
    integrity="sha256-jwf61Kvt/V6xOWxv74W6fsAOyGenn7VFydsY34f2dgo="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA=="
    crossorigin="anonymous"
  />
  
  <link rel="shortcut icon" href="https://underscorehao.net/favicons/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://underscorehao.net/favicons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://underscorehao.net/favicons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://underscorehao.net/favicons/favicon-16x16.png" />

  <link rel="canonical" href="https://underscorehao.net/2020/01/publishing-to-multiple-topics-in-azure-service-bus/" />

  
  
  
  
  <script
    type="text/javascript"
    src="https://underscorehao.net/js/anatole-header.min.413f798d8aa82610bef17a5ca1d7e962ec185be395f1aeb3f45d1891af568b65.js"
    integrity="sha256-QT95jYqoJhC&#43;8XpcodfpYuwYW&#43;OV8a6z9F0Yka9Wi2U="
    crossorigin="anonymous"
  ></script>

  
    
    
    <script
      type="text/javascript"
      src="https://underscorehao.net/js/anatole-theme-switcher.min.fcf9526f15b3b4e08472de192969ab28a4cdcb32ac94f83e85a8b84e9b45acd2.js"
      integrity="sha256-/PlSbxWztOCEct4ZKWmrKKTNyzKslPg&#43;hai4TptFrNI="
      crossorigin="anonymous"
    ></script>

  
  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://underscorehao.net/images/site-feature-image.png"/>

<meta name="twitter:title" content="Publishing to Multiple Topics in Azure Service Bus"/>
<meta name="twitter:description" content="Multiple topics There are two main approaches when it comes to topics in Azure Service Bus."/>



  


  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "posts",
        "name": "Publishing to Multiple Topics in Azure Service Bus",
        "headline": "Publishing to Multiple Topics in Azure Service Bus",
        "alternativeHeadline": "",
        "description": "
      
        Multiple topics There are two main approaches when it comes to topics in Azure Service Bus.


      


    ",
        "inLanguage": "en",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/underscorehao.net\/2020\/01\/publishing-to-multiple-topics-in-azure-service-bus\/"
        },
        "author" : {
            "@type": "Person",
            "name": "_hao"
        },
        "creator" : {
            "@type": "Person",
            "name": "_hao"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "_hao"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "_hao"
        },
        "copyrightYear" : "2020",
        "dateCreated": "2020-01-11T19:33:48.00Z",
        "datePublished": "2020-01-11T19:33:48.00Z",
        "dateModified": "2020-01-11T19:33:48.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "_hao",
            "url": "https://underscorehao.net/",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/underscorehao.net\/favicons\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
        
        "https://underscorehao.net/images/site-feature-image.png"


      
      ]

    ,
        "url" : "https:\/\/underscorehao.net\/2020\/01\/publishing-to-multiple-topics-in-azure-service-bus\/",
        "wordCount" : "1223",
        "genre" : [ 
      
      "Software Development"

    ],
        "keywords" : [ 
      
      "C#"

    
      
        ,

      
      ".NET"

    
      
        ,

      
      "Azure"

    ]
    }
  </script>



</head>
<body>
    <header><div
  class="page-top 
    animated fadeInDown

  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true"></span>
    <span aria-hidden="true"></span>
    <span aria-hidden="true"></span>
  </a>
  <nav>
    <ul class="nav__list" id="navMenu">
      <div class="nav__links">
        
        
          
          <li>
            <a
              
              href="https://underscorehao.net/"
              
              title=""
              >Home</a
            >
          </li>

        
          
          <li>
            <a
              
              href="https://underscorehao.net/posts/"
              
              title=""
              >Blog</a
            >
          </li>

        
          
          <li>
            <a
              
              href="https://underscorehao.net/about/"
              
              title=""
              >About</a
            >
          </li>

        
          
          <li>
            <a
              
              href="https://underscorehao.net/contact/"
              
              title=""
              >Contact</a
            >
          </li>

        
      </div>
      <ul>
        
        
          <li>
            <a class="theme-switch" title="Switch Theme">
              <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
          </li>

        
      </ul>
    </ul>
  </nav>
</div>
</header>
    <div class="wrapper">
      <aside><div
  class="sidebar
    animated fadeInDown

  "
>
  <div class="sidebar__content">
    <div class="logo-title">
      <div class="title">
        <img src="https://underscorehao.net/images/avatar.jpg" alt="profile picture" />
        <h3 title=""><a href="https://underscorehao.net/">Pavel Danov</a></h3>
        <div class="description">
          <p>Life and Tech</p>
        </div>
      </div>
    </div>
    <ul class="social-links">
      
        <li>
          <a href="https://twitter.com/underscoreHao/" rel="me" aria-label="Twitter" title="Twitter">
            <i class="fab fa-twitter fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li>
          <a href="https://github.com/underscoreHao/" rel="me" aria-label="GitHub" title="GitHub">
            <i class="fab fa-github fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li>
          <a href="https://stackoverflow.com/users/2265179/underscorehao" rel="me" aria-label="Stack Overflow" title="Stack Overflow">
            <i class="fab fa-stack-overflow fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li>
          <a href="https://news.ycombinator.com/user?id=_hao" rel="me" aria-label="Hacker News" title="Hacker News">
            <i class="fab fa-hacker-news fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li>
          <a href="mailto:underscorehao@gmail.com" rel="me" aria-label="e-mail" title="e-mail">
            <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li>
          <a href="https://underscorehao.net/index.xml" rel="me" aria-label="RSS" title="RSS">
            <i class="fas fa-rss fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
    </ul>
  </div><footer class="footer footer--sidebar">
  <div class="by_farbox">
    <ul class="footer__list">
      <li class="footer__item">
        &copy;
        
          2017-2022

        
      </li>
      
    </ul>
  </div>
</footer>
  
  <script
    type="text/javascript"
    src="https://underscorehao.net/js/medium-zoom.min.bdc7b23aff63497a79433b3920b03e2473399d90ad4c2d87cf7c08d33d61966f.js"
    integrity="sha256-vceyOv9jSXp5Qzs5ILA&#43;JHM5nZCtTC2Hz3wI0z1hlm8="
    crossorigin="anonymous"
  ></script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-106583563-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
</div>
</aside>
      <main>
        <div class="autopagerize_page_element">
          <div class="content">
  <div
    class="post 
      animated fadeInDown

    "
  >
    <div class="post-content">
      
      <div class="post-title">
        <h1>Publishing to Multiple Topics in Azure Service Bus</h1>
        
      </div><h2 id="multiple-topics">Multiple topics</h2>
<p>There are two main approaches when it comes to topics in Azure Service Bus. Depending what&rsquo;s your architecture and needs you can have either:</p>
<ul>
<li><strong>Filtered topic</strong> - this means you have only one topic for all of your event types. All publishers push messages onto that single topic. Some of the message fields and properties are then used for filtering by the subscribers since in most cases a subscriber will be interested only in certain types of messages.</li>
<li><strong>Multiple topics</strong> - you have multiple topics for different domain events or channels of your system. You can still leverage the filtering to have more granular control in your subscribers. You can also have topics based on priority, event types etc.</li>
</ul>
<p>Our main concern in this post is the second use case and how to build a nice <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.servicebus.topicclient?view=azure-dotnet"><strong><code>ITopicClient</code></strong></a> factory inside a .NET Core project. I&rsquo;ve built my example with Azure Functions, but 99.9% of the code is completely identical to what you would do in a normal .NET Core web service.</p>
<h2 id="basic-setup">Basic Setup</h2>
<p>If you haven&rsquo;t used <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.servicebus.topicclient?view=azure-dotnet"><strong><code>ITopicClient</code></strong></a> and Azure Service Bus I recommend you read the following two articles before continuing:</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-quickstart-topics-subscriptions-portal">Create Azure Service Bus topics and subscriptions</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-dotnet-how-to-use-topics-subscriptions">Getting started with Service Bus topics</a></li>
</ul>
<p>Now that we know what libraries we&rsquo;ll be using we can start building our solution. The first step is to create our TopicClient which is easy enough</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">topicClient</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TopicClient</span><span class="p">(</span><span class="s">&#34;AzureServiceBusConnectionString&#34;</span><span class="p">,</span> <span class="s">&#34;TopicName&#34;</span><span class="p">);</span>
</code></pre></div><p>The two things we need are the ASB connection string and the topic to which we would like to publish messages.</p>
<p>Let&rsquo;s get the boilerplate code that is going to be used onward out of the way first. You&rsquo;ll need to have something like that in your <code>appsettings.json</code> file</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;ServiceBus&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;Endpoint&#34;</span><span class="p">:</span> <span class="s2">&#34;AsbFooBarEndpoint&#34;</span><span class="p">,</span>
        <span class="nt">&#34;FooTopic&#34;</span><span class="p">:</span> <span class="s2">&#34;foo&#34;</span><span class="p">,</span>
        <span class="nt">&#34;BarTopic&#34;</span><span class="p">:</span> <span class="s2">&#34;bar&#34;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>And a simple POCO that you can map it to</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">ServiceBusOptions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Endpoint</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">FooTopic</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="kt">string</span> <span class="n">BarTopic</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Then you register your options in the startup</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="k">void</span> <span class="n">BindConfigurationOptions</span><span class="p">(</span><span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">services</span><span class="p">.</span><span class="n">Configure</span><span class="p">&lt;</span><span class="n">ServiceBusOptions</span><span class="p">&gt;(</span><span class="n">options</span> <span class="p">=&gt;</span>
        <span class="n">Configuration</span><span class="p">.</span><span class="n">GetSection</span><span class="p">(</span><span class="s">&#34;ServiceBus&#34;</span><span class="p">)</span>
            <span class="p">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">options</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div><h2 id="the-naïve-approach">The naïve approach</h2>
<p>If we were doing the first example (filtered topic) we are pretty much done. You can register your <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.servicebus.topicclient?view=azure-dotnet"><strong><code>ITopicClient</code></strong></a> as a <a href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-performance-improvements#reusing-factories-and-clients"><strong>singleton</strong></a> and inject it in your DI container.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="c1">// This is the Azure Functions host builder
</span><span class="c1">// In a web service you&#39;ll have the IServiceCollection
</span><span class="c1"></span><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">Configure</span><span class="p">(</span><span class="n">IFunctionsHostBuilder</span> <span class="n">builder</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">ITopicClient</span><span class="p">&gt;(</span><span class="n">x</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">options</span> <span class="p">=</span> <span class="n">x</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IOptions</span><span class="p">&lt;</span><span class="n">ServiceBusOptions</span><span class="p">&gt;&gt;();</span>
        <span class="k">return</span> <span class="k">new</span> <span class="k">new</span> <span class="n">TopicClient</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">Endpoint</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">FooTopic</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div><p>Finally you just use the injected client to send messages to the <code>Foo</code> topic</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="c1">// Code below uses a MediatR handler as an example
</span><span class="c1"></span><span class="k">public</span> <span class="k">class</span> <span class="nc">FooHandler</span> <span class="p">:</span> <span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">Foo</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">ITopicClient</span> <span class="n">topicClient</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">FooHandler</span><span class="p">(</span><span class="n">ITopicClient</span> <span class="n">topicClient</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">topicClient</span> <span class="p">=</span> <span class="n">topicClient</span> <span class="p">??</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">ArgumentNullException</span><span class="p">(</span><span class="n">nameof</span><span class="p">(</span><span class="n">topicClient</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">Handle</span><span class="p">(</span><span class="n">Foo</span> <span class="n">request</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">request</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">ArgumentNullException</span><span class="p">(</span><span class="n">nameof</span><span class="p">(</span><span class="n">request</span><span class="p">));</span>

        <span class="k">try</span>
        <span class="p">{</span>
            <span class="k">await</span> <span class="n">topicClient</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>And that&rsquo;s that. We&rsquo;re done.</p>
<p>What happens however if we have to accommodate multiple topics? Do we inject multiple topics in the service/handler? Depending on your DI container are you even able to put multiple implementations of the same interface? Do we use a bunch of if statements and introduce cyclomatic complexity for deciding which topic client we want? These are all viable questions and solutions, but one elegant answer is hidden in the next section.</p>
<h2 id="introducing-the-itopicclient-resolver">Introducing the ITopicClient resolver</h2>
<p>In order to solve the problem at hand I want to minimize the complexity of dealing with multiple topics. I want the usage to be as simple as when using only one just like in the previous example. So how do we do that?</p>
<p>The first part of the problem is how to differentiate between the topic clients for each topic. We can do that by creating small wrapper classes around each client we have.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">FooClient</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">readonly</span> <span class="n">ITopicClient</span> <span class="n">TopicClient</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">FooClient</span><span class="p">(</span><span class="n">IOptions</span><span class="p">&lt;</span><span class="n">ServiceBusOptions</span><span class="p">&gt;</span> <span class="n">options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">TopicClient</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TopicClient</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">Endpoint</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">FooTopic</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">BarClient</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">readonly</span> <span class="n">ITopicClient</span> <span class="n">TopicClient</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">BarClient</span><span class="p">(</span><span class="n">IOptions</span><span class="p">&lt;</span><span class="n">ServiceBusOptions</span><span class="p">&gt;</span> <span class="n">options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">TopicClient</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TopicClient</span><span class="p">(</span><span class="n">options</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">Endpoint</span><span class="p">,</span> <span class="n">options</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">BarTopic</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Now that we have our clients we are going to create a factory with the help of a <code>delegate</code>. Based on a <code>key</code> we&rsquo;ll return the exact topic client we want when we want it!</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">Microsoft.Azure.ServiceBus</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">FooBarApp.Clients</span>
<span class="p">{</span>
    <span class="c1">// The key can be a string, Type, enum, int - whatever you need really
</span><span class="c1"></span>    <span class="k">public</span> <span class="k">delegate</span> <span class="n">ITopicClient</span> <span class="n">TopicResolver</span><span class="p">(</span><span class="kt">string</span> <span class="n">key</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>The step where the magic happens is in our DI registration.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="c1">// This is the Azure Functions host builder
</span><span class="c1">// In a web service you&#39;ll have the IServiceCollection
</span><span class="c1"></span><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="n">Configure</span><span class="p">(</span><span class="n">IFunctionsHostBuilder</span> <span class="n">builder</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">FooClient</span><span class="p">&gt;();</span>
    <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">BarClient</span><span class="p">&gt;();</span>
    <span class="n">builder</span><span class="p">.</span><span class="n">Services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">TopicResolver</span><span class="p">&gt;(</span><span class="n">topicProvider</span> <span class="p">=&gt;</span> <span class="n">key</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="c1">// The key can be a string, Type, enum, int - whatever you need really
</span><span class="c1"></span>        <span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">case</span> <span class="s">&#34;Foo&#34;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">topicProvider</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">FooClient</span><span class="p">&gt;().</span><span class="n">TopicClient</span><span class="p">;</span>
            <span class="k">case</span> <span class="s">&#34;Bar&#34;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">topicProvider</span><span class="p">.</span><span class="n">GetService</span><span class="p">&lt;</span><span class="n">BarClient</span><span class="p">&gt;().</span><span class="n">TopicClient</span><span class="p">;</span>
            <span class="k">default</span><span class="p">:</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">KeyNotFoundException</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div><p>Let&rsquo;s me explain what&rsquo;s happening here. First we&rsquo;re registering our named clients as <a href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-performance-improvements#reusing-factories-and-clients"><strong>singletons</strong></a> per the explanations and reasoning given in the documentation.</p>
<p>Next we register our <code>delegate</code> as a transient service that will return one of the topic clients we already registered based on a <code>key</code>. For my usage I use a <code>string</code> key stored inside the <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.azure.servicebus.message.userproperties?view=azure-dotnet#Microsoft_Azure_ServiceBus_Message_UserProperties">message user properties</a>. Your <code>key</code> can be anything like <code>int</code>, <code>enum</code> or a specific <code>Type</code>.</p>
<p>Last thing we have to do is to put our <code>TopicResolver</code> to work!</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="c1">// Code below uses a MediatR handler as an example
</span><span class="c1"></span><span class="k">public</span> <span class="k">class</span> <span class="nc">MessageHandler</span> <span class="p">:</span> <span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">Message</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">TopicResolver</span> <span class="n">topicResolver</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">MessageHandler</span><span class="p">(</span><span class="n">TopicResolver</span> <span class="n">topicResolver</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">topicResolver</span> <span class="p">=</span> <span class="n">topicResolver</span> <span class="p">??</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">ArgumentNullException</span><span class="p">(</span><span class="n">nameof</span><span class="p">(</span><span class="n">topicResolver</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span> <span class="n">Handle</span><span class="p">(</span><span class="n">Message</span> <span class="n">msg</span><span class="p">,</span> <span class="n">CancellationToken</span> <span class="n">cancellationToken</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">ArgumentNullException</span><span class="p">(</span><span class="n">nameof</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>

        <span class="k">try</span>
        <span class="p">{</span>
             <span class="c1">// Use a field from the user properties of the message as key
</span><span class="c1"></span>             <span class="c1">// The client we get can be either FooClient or BarClient based on the value
</span><span class="c1"></span>            <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">topicResolver</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">UserProperties</span><span class="p">[</span><span class="s">&#34;Key&#34;</span><span class="p">]);</span>
            <span class="k">await</span> <span class="n">client</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>As a bonus here&rsquo;s how to test if the <code>delegate</code> is doing it&rsquo;s job and verifying that the right client is called.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">AutoFixture</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">MediatR</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Azure.ServiceBus</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Moq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Shouldly</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Xunit</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">FooBarApp.Tests</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MessageHandlerTests</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">TopicResolver</span><span class="p">&gt;</span> <span class="n">topicResolver</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">Fixture</span> <span class="n">fixture</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">IRequestHandler</span><span class="p">&lt;</span><span class="n">Message</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">sut</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">MessageHandlerTests</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">topicResolver</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">TopicResolver</span><span class="p">&gt;();</span>
            <span class="n">fixture</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Fixture</span><span class="p">();</span>
        <span class="p">}</span>
<span class="na">
</span><span class="na">        [Fact]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">Handle_ValidMessageRequest_Foo_SendsMessage</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="n">fixture</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">Message</span><span class="p">&gt;();</span>
            <span class="c1">// Best will be to create a customizer for different Messages
</span><span class="c1"></span>            <span class="n">message</span><span class="p">.</span><span class="n">UserProperties</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">&#34;Key&#34;</span><span class="p">,</span> <span class="s">&#34;Foo&#34;</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">ITopicClient</span><span class="p">&gt;();</span>

            <span class="n">topicResolver</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()))</span>
                <span class="p">.</span><span class="n">Returns</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>

            <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MessageHandler</span><span class="p">(</span><span class="n">topicResolver</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>

            <span class="k">await</span> <span class="n">sut</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="k">default</span><span class="p">);</span>

            <span class="n">topicResolver</span><span class="p">.</span><span class="n">Verify</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">(</span><span class="s">&#34;Foo&#34;</span><span class="p">),</span> <span class="n">Times</span><span class="p">.</span><span class="n">Once</span><span class="p">);</span>
            <span class="n">client</span><span class="p">.</span><span class="n">Verify</span><span class="p">((</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="n">Message</span><span class="p">&gt;())),</span> <span class="n">Times</span><span class="p">.</span><span class="n">Once</span><span class="p">);</span>
        <span class="p">}</span>
<span class="na">
</span><span class="na">        [Fact]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">Handle_ValidMessageRequest_Bar_SendsMessage</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">message</span> <span class="p">=</span> <span class="n">fixture</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">Message</span><span class="p">&gt;();</span>
            <span class="c1">// Best will be to create a customizer for different Messages
</span><span class="c1"></span>            <span class="n">message</span><span class="p">.</span><span class="n">UserProperties</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s">&#34;Key&#34;</span><span class="p">,</span> <span class="s">&#34;Bar&#34;</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">ITopicClient</span><span class="p">&gt;();</span>

            <span class="n">topicResolver</span><span class="p">.</span><span class="n">Setup</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;()))</span>
                <span class="p">.</span><span class="n">Returns</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>

            <span class="n">sut</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MessageHandler</span><span class="p">(</span><span class="n">topicResolver</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>

            <span class="k">await</span> <span class="n">sut</span><span class="p">.</span><span class="n">Handle</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="k">default</span><span class="p">);</span>

            <span class="n">topicResolver</span><span class="p">.</span><span class="n">Verify</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">(</span><span class="s">&#34;Bar&#34;</span><span class="p">),</span> <span class="n">Times</span><span class="p">.</span><span class="n">Once</span><span class="p">);</span>
            <span class="n">client</span><span class="p">.</span><span class="n">Verify</span><span class="p">((</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">SendAsync</span><span class="p">(</span><span class="n">It</span><span class="p">.</span><span class="n">IsAny</span><span class="p">&lt;</span><span class="n">Message</span><span class="p">&gt;())),</span> <span class="n">Times</span><span class="p">.</span><span class="n">Once</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>And that&rsquo;s it! With this setup now you can add multiple topic clients with ease! Hope you find this post useful. There are other ways to accomplish the same thing and solve this problem, but I like this approach because it&rsquo;s extremely clean, elegant and testable!</p>
</div>
    <div class="post-footer">
      <div class="info">
        
          <span class="separator"><a class="category" href="https://underscorehao.net/categories/software-development/">Software Development</a></span>




        

        
          <span class="separator"><a class="tag" href="https://underscorehao.net/tags/c%23/">C#</a><a class="tag" href="https://underscorehao.net/tags/%2enet/">.NET</a><a class="tag" href="https://underscorehao.net/tags/azure/">Azure</a></span>




        
      </div>
    </div>

    
  </div>


          </div>
        </div>
      </main>
    </div><footer class="footer footer--base">
  <div class="by_farbox">
    <ul class="footer__list">
      <li class="footer__item">
        &copy;
        
          2017-2022

        
      </li>
      
    </ul>
  </div>
</footer>
  
  <script
    type="text/javascript"
    src="https://underscorehao.net/js/medium-zoom.min.bdc7b23aff63497a79433b3920b03e2473399d90ad4c2d87cf7c08d33d61966f.js"
    integrity="sha256-vceyOv9jSXp5Qzs5ILA&#43;JHM5nZCtTC2Hz3wI0z1hlm8="
    crossorigin="anonymous"
  ></script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-106583563-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
</body>
</html>
