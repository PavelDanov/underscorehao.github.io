














<!DOCTYPE html>
<html lang='en'><head>
    <meta charset="utf-8">
    <link rel="shortcut icon" href='/favicon.ico' type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>.NET Core API with DynamoDB Context Dependency Injection - Pavel Danov</title>

    

    

    
    <meta name="author" content="Pavel Danov" />
    

    
        <meta property="og:title" content=".NET Core API with DynamoDB Context Dependency Injection" />
<meta property="og:description" content="The Problem Today I faced a problem which I knew would come, but didn&rsquo;t have time to implement properly at the time. There were more urgent tasks at hand before, deadlines to be met and this issue remained unresolved.
Amazon&rsquo;s .NET Core SDK is very good for the most part. Everything works as it should. But let&rsquo;s say you use the .NET Object Persistence Model for DynamoDB in your service and you have mapped C# classes to DynamoDB tables like this:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://underscorehao.net/2018/03/net-core-api-dynamodb-dependency-injection/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-03-13T22:27:05+02:00" />
<meta property="article:modified_time" content="2018-03-13T22:27:05+02:00" />


    

    
        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content=".NET Core API with DynamoDB Context Dependency Injection"/>
<meta name="twitter:description" content="The Problem Today I faced a problem which I knew would come, but didn&rsquo;t have time to implement properly at the time. There were more urgent tasks at hand before, deadlines to be met and this issue remained unresolved.
Amazon&rsquo;s .NET Core SDK is very good for the most part. Everything works as it should. But let&rsquo;s say you use the .NET Object Persistence Model for DynamoDB in your service and you have mapped C# classes to DynamoDB tables like this:"/>

    <link rel="stylesheet" href="/style.min.5297c96c59a52afaa5bcda4a6cedf3813081f64025c209b25b2ee6d0c8f74d462b625ad3404a92a14d7a51b4ec0a420337ae70f426fa4bce2d5f7459a3ca7274.css" integrity="sha512-UpfJbFmlKvqlvNpKbO3zgTCB9kAlwgmyWy7m0Mj3TUYrYlrTQEqSoU16UbTsCkIDN65w9Cb6S84tX3RZo8pydA==">



    <link rel="stylesheet" href="/lib/css/prism.min.6226f06f992e0d6166b0e26724efd050dcc381202a752892ba523b1b865de2ea5e427f8f7d10de682fc35d6e7444018247d1f25db5e1e3bab17068ce191c5886.css" integrity="sha512-Yibwb5kuDWFmsOJnJO/QUNzDgSAqdSiSulI7G4Zd4upeQn&#43;PfRDeaC/DXW50RAGCR9HyXbXh47qxcGjOGRxYhg==">


        
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-106583563-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    

    
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.setAttribute("data-theme", "dark");
        } else {
            document.documentElement.setAttribute("data-theme", "light");
        }
    </script>
<script defer src="/js/header.7a2a109ec3782c57bad0332b662f8a5f41765505936b69868eb8bd5241de9daf23c388e82ca1831f6d09935013dcb9f71bfa7face3975880c1076028b7b0a6e1.js" integrity="sha512-eioQnsN4LFe60DMrZi&#43;KX0F2VQWTa2mGjri9UkHena8jw4joLKGDH20Jk1AT3Ln3G/p/rOOXWIDBB2Aot7Cm4Q=="></script>



    <script defer src="/js/zooming.fc76b730bcba24949cb337c58c5e935f727dbea8418e918e3b1794f0707d130aadf4ead341e9305a2c6045f7bc66700d73cc5c7f5d8f6ae2c7631e095f4e18ae.js" integrity="sha512-/Ha3MLy6JJScszfFjF6TX3J9vqhBjpGOOxeU8HB9Ewqt9OrTQekwWixgRfe8ZnANc8xcf12PauLHYx4JX04Yrg=="></script>




    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script defer src="/js/math.d7efde37b2eb8879651e1f4489bcd4d8203b8c2bf8ca12c9e1b8cd11bfd6395b172f4999fff43ce0d047889a2bdb71ee74aebbae5327590192d1144e790fcd7b.js" integrity="sha512-1&#43;/eN7LriHllHh9EibzU2CA7jCv4yhLJ4bjNEb/WOVsXL0mZ//Q84NBHiJor23HudK67rlMnWQGS0RROeQ/New=="></script>




    
        

        
        

        
        
            
        

        <script defer src="/js/prism.3113e52d215fde553c8747fb87544cc26ae5ab9b25e8ab7e7ab767824138bca8c0edb05a3c2d6dbcda075db565c7025817f6f6eea26a5d14c4e53397ae7748e2.js" integrity="sha512-MRPlLSFf3lU8h0f7h1RMwmrlq5sl6Kt&#43;erdngkE4vKjA7bBaPC1tvNoHXbVlxwJYF/b27qJqXRTE5TOXrndI4g==" data-manual></script>
    



    
    
    
    <script defer src="/js/search-en.677e05c714f837051483647d736c45051126c22a2696ca5f981b59da962d48962f3ea71150f559ba84884fd1aadf1c7aadce55bb31a3e5b75c0f173b763c109a.js" integrity="sha512-Z34FxxT4NwUUg2R9c2xFBREmwiomlspfmBtZ2pYtSJYvPqcRUPVZuoSIT9Gq3xx6rc5VuzGj5bdcDxc7djwQmg=="></script>




</head><body>
        <main><header>
    <div class="brand">
        <div id="sidebar_btn">
            <svg id="menu_icon" width="26px" height="26px" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></svg>
        </div>

        <div>
            <a href="/">Pavel Danov</a>
        </div>
    </div>

    <div class="toolbox">
        <div id="theme_tool">
            <svg id="dark_mode_btn" class="hidden toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></svg>
            <svg id="light_mode_btn" class="hidden toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></svg>
        </div>

        
            <div id="search_tool">
                <svg id="search_btn" class="toolbox-btn" width="18px" height="18px" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></svg><div id="search_menu_wrapper" class="hidden">
    <div id="search_menu">
        <div id="search_menu_toolbar">
            <div id="search_menu_input_wrapper">
                <input id="search_menu_input" type="text" placeholder='Search Posts'>
            </div>
            <div id="search_menu_close_btn">
                <svg width="18px" height="18px" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></svg>
            </div>
        </div>
        <div id="search_menu_results">
        </div>
    </div>
</div>
</div>
        

        
            <div id="translation_tool" class="dropdown-wrapper pure-menu pure-menu-horizontal toolbox-btn">
                <ul class="pure-menu-list">
                    <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
                        <div class="dropdown-btn pure-menu-link">
                            <svg width="18px" height="18px" viewBox="0 0 24 24"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-globe"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg></svg>
                            <span class="dropdown-desc">English</span>
                        </div>
                        <ul class="pure-menu-children">
                            
                            <li class="pure-menu-item">
                                <a href="https://underscorehao.net/" class="pure-menu-link">English</a>
                            </li>
                            
                            <li class="pure-menu-item">
                                <a href="https://underscorehao.net/bg/" class="pure-menu-link">Български</a>
                            </li>
                            
                        </ul>
                    </li>
                </ul>
            </div>
        
    </div>
</header>
<nav id="navbar" class="pure-menu"><ul class="pure-menu-list"><li class="navbar-item pure-menu-item ">
                    
                        <a href="/posts/" class="pure-menu-link">Blog</a>
                    
                </li><li class="navbar-item pure-menu-item ">
                    
                        <a href="/notes/" class="pure-menu-link">Notes</a>
                    
                </li></ul>
</nav>
<div id="sidebar_canvas_overlay" class="hidden"></div>
<div id="sidebar" class="close">
    <ul><li>
                    <a href="/posts/">Blog</a>
                </li><li>
                    <a href="/notes/">Notes</a>
                </li></ul>
</div><div id="content" class="content-margin">
                
    
    <div class="collapsible-menu-wrapper"><div class="collapsible-menu-type"><span>Table of contents</span></div><div class="collapsible-menu">
        
            <nav id="TableOfContents">
  <ul>
    <li><a href="#the-problem">The Problem</a></li>
    <li><a href="#the-solution">The Solution</a></li>
  </ul>
</nav>
        
    </div></div>



    <div class="content-margin">

<article >
    
    
        
        
    
    <h2 id="the-problem">The Problem</h2>
<p>Today I faced a problem which I knew would come, but didn&rsquo;t have time to implement properly at the time. There were more urgent tasks at hand before, deadlines to be met and this issue remained unresolved.</p>
<p>Amazon&rsquo;s .NET Core SDK is very good for the most part. Everything works as it should. But let&rsquo;s say you use the <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DotNetSDKHighLevel.html">.NET Object Persistence Model</a> for <a href="https://aws.amazon.com/dynamodb/">DynamoDB</a> in your service and you have mapped C# classes to DynamoDB tables like this:</p>
<pre  class="mc-prism hide language-text" ><code class="language-csharp">namespace Models
{
    [DynamoDBTable(&quot;Player&quot;)]
    public class Player
    {
        [DynamoDBHashKey]
        public int Id { get; set; }

        [DynamoDBProperty]
        public string Name { get; set; }

        [DynamoDBProperty]
        public int HitPoints { get; set; }

        [DynamoDBProperty]
        public int Gold { get; set; }

        [DynamoDBProperty]
        public int Level { get; set; }

        [DynamoDBProperty]
        public List&lt;string&gt; Items { get; set; }
    }

    [DynamoDBTable(&quot;Location&quot;)]
    public class Location
    {
        [DynamoDBHashKey]
        public int Id { get; set; }

        [DynamoDBProperty]
        public string Name { get; set; }

        [DynamoDBProperty]
        public string Description { get; set; }
    }
}
</code></pre>
<p>It works well. Everything is mapped as it should. You have a service that calls the .NET SDK so you can write, read and delete data from the context like this:</p>
<pre  class="mc-prism hide language-text" ><code class="language-csharp">namespace Services
{
    public class DynamoDbService
    {
        public async Task&lt;T&gt; GetAsync&lt;T&gt;(string id)
        {
            try
            {
                DynamoDBContext context = new DynamoDBContext(_dynamoDbClient);
                return await context.LoadAsync&lt;T&gt;(id);
            }
            catch (Exception ex)
            {
                throw new Exception($&quot;Amazon error in Get operation! Error: {ex}&quot;);
            }
        }

        public async Task WriteAsync&lt;T&gt;(T item)
        {
            try
            {
                DynamoDBContext context = new DynamoDBContext(_dynamoDbClient);
                await context.SaveAsync(item);
            }
            catch (Exception ex)
            {
                throw new Exception($&quot;Amazon error in Write operation! Error: {ex}&quot;);
            }
        }

        public async Task DeleteAsync&lt;T&gt;(T item)
        {
            try
            {
                DynamoDBContext context = new DynamoDBContext(_dynamoDbClient);
                await context.DeleteAsync(item)
            }
            catch (Exception ex)
            {
                throw new Exception($&quot;Amazon error in Delete operation! Error: {ex}&quot;);
            }
        }
    }
}
</code></pre>
<p>It&rsquo;s all fun and games until you have to use different databases for different environments! Of course you can use the <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DotNetSDKMidLevel.html">Document Model</a>, but then you lose the nice mapping to C# classes and have to work with generic documents.</p>
<p>C# attributes are not meant to change at runtime, so we&rsquo;re in a tough spot! What can we do to tell our build pipeline which tables we&rsquo;d like to use?</p>
<h2 id="the-solution">The Solution</h2>
<p>.NET Core&rsquo;s powerful dependency injection comes to our rescue! First we create the same section (with the respective databases for our environments) in our <strong><code>appsettings.Development.json</code></strong></p>
<pre  class="mc-prism hide language-text" ><code class="language-json">&quot;DynamoDbTables&quot;: {
    &quot;Player&quot;: &quot;DevPlayer&quot;,
    &quot;Location&quot;: &quot;DevLocation&quot;
}
</code></pre>
<p>and <strong><code>appsettings.json</code></strong> file</p>
<pre  class="mc-prism hide language-text" ><code class="language-json">&quot;DynamoDbTables&quot;: {
    &quot;Player&quot;: &quot;ProdPlayer&quot;,
    &quot;Location&quot;: &quot;ProdLocation&quot;
}
</code></pre>
<p>Then we head up and create a simple configuration class which we&rsquo;ll bind to our DynamoDbTables JSON object later</p>
<pre  class="mc-prism hide language-text" ><code class="language-csharp">public class DynamoDbOptions
{
    public string Player { get; set; }
    public string Location { get; set; }
}
</code></pre>
<p>After that we have to create our custom DynamoDb context interface</p>
<pre  class="mc-prism hide language-text" ><code class="language-csharp">public interface IDynamoDbContext&lt;T&gt; : IDisposable where T : class
{
    Task&lt;T&gt; GetByIdAsync(string id);
    Task SaveAsync(T item);
    Task DeleteByIdAsync(T item);
}
</code></pre>
<p>and the context class which we&rsquo;ll inject in our services</p>
<pre  class="mc-prism hide language-text" ><code class="language-csharp">public class DynamoDbContext&lt;T&gt; : DynamoDBContext, IDynamoDbContext&lt;T&gt;
    where T : class
{
    private DynamoDBOperationConfig _config;

    public DynamoDbContext(IAmazonDynamoDB client, string tableName)
        : base(client)
    {
        _config = new DynamoDBOperationConfig()
        {
            OverrideTableName = tableName
        };
    }

    public async Task&lt;T&gt; GetByIdAsync(string id)
    {
        return await base.LoadAsync&lt;T&gt;(id, _config);
    }

    public async Task SaveAsync(T item)
    {
        await base.SaveAsync(item, _config);
    }

    public async Task DeleteByIdAsync(T item)
    {
        await base.DeleteAsync(item, _config);
    }
}
</code></pre>
<p>Then we go to our <strong><code>Startup.cs</code></strong> and add a couple of lines to our <strong><code>ConfigureServices()</code></strong> method</p>
<pre  class="mc-prism hide language-text" ><code class="language-csharp">// AWS Options
var awsOptions = Configuration.GetAWSOptions();
services.AddDefaultAWSOptions(awsOptions);

var client = awsOptions.CreateServiceClient&lt;IAmazonDynamoDB&gt;();
var dynamoDbOptions = new DynamoDbOptions();
ConfigurationBinder.Bind(Configuration.GetSection(&quot;DynamoDbTables&quot;), dynamoDbOptions);

// This is where the magic happens
services.AddScoped&lt;IDynamoDbContext&lt;Player&gt;&gt;(provider =&gt; new DynamoDbContext&lt;Player&gt;(client, dynamoDbOptions.Player));
services.AddScoped&lt;IDynamoDbContext&lt;Location&gt;&gt;(provider =&gt; new DynamoDbContext&lt;Location&gt;(client, dynamoDbOptions.Location));
</code></pre>
<p>And voilà! We can now remove the <strong><code>[DynamoDBTable(&quot;SomeTableName&quot;)]</code></strong> attributes from our classes. We can keep both <strong><code>[DynamoDBHashKey]</code></strong> and <strong><code>[DynamoDBProperty]</code></strong> attributes. If we need custom converters we can just add <strong><code>[DynamoDBProperty(typeof(SomeConverter))]</code></strong> attribute to our property.</p>
<pre  class="mc-prism hide language-text" ><code class="language-csharp">// No table name attribute needed!
public class Player
{
    [DynamoDBHashKey]
    public int Id { get; set; }

    [DynamoDBProperty]
    public string Name { get; set; }

    [DynamoDBProperty]
    public int HitPoints { get; set; }

    [DynamoDBProperty]
    public int Gold { get; set; }

    [DynamoDBProperty]
    public int Level { get; set; }

    [DynamoDBProperty]
    public List&lt;string&gt; Items { get; set; }
}

// No table name attribute needed!
public class Location
{
    [DynamoDBHashKey]
    public int Id { get; set; }

    [DynamoDBProperty]
    public string Name { get; set; }

    [DynamoDBProperty]
    public string Description { get; set; }
}
</code></pre>
<p>and we can use the desired context with their respective tables in our services!</p>
<pre  class="mc-prism hide language-text" ><code class="language-csharp">namespace Services
{
    public class AwesomeDynamoDbService
    {
        private IDynamoDbContext&lt;Player&gt; _playerContext;
        private IDynamoDbContext&lt;Location&gt; _locationContext;

        public AwesomeDynamoDbService(IDynamoDbContext&lt;Player&gt; playerContext, IDynamoDbContext&lt;Location&gt; locationContext)
        {
            _playerContext = playerContext;
            _locationContext = locationContext;
        }

        public async Task&lt;User&gt; GetUserAsync(string id)
        {
            try
            {
                return await _playerContext.GetByIdAsync(id);
            }
            catch (Exception ex)
            {
                throw new Exception($&quot;Amazon error in GetUser table operation! Error: {ex}&quot;);
            }
        }

        public async Task&lt;Location&gt; GetLocationAsync(string id)
        {
            try
            {
                return await _locationContext.GetByIdAsync(id);
            }
            catch (Exception ex)
            {
                throw new Exception($&quot;Amazon error in GetLocation table operation! Error: {ex}&quot;);
            }
        }
    }
}
</code></pre>
<p>Depending on your case you can use different services for different tables or other requirements. This solution might seem a bit more cumbersome than the original, but it makes us flexible in case we need to work with multiple databases and different build environments. The only thing you have to do is to tell your build tool/pipeline to change the table names in your <strong><code>appsettings.json</code></strong> files.</p>
<p>This method also is more robust when it comes to testing because it&rsquo;ll be much easier to mock! All in all I&rsquo;m really happy with how it all turned out!</p>

</article>
</div>


                
                    
                
            </div>
<footer>
    <article>Copyright © 2017-2022 by Pavel Danov</article>
</footer>

</main>
    </body>
</html>
