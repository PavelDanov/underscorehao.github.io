<!DOCTYPE html>
<html
  dir="ltr"
  lang="en"
  data-theme=""
  class="html"
><head>
  <title>
    
      
        .NET Core API with DynamoDB Context Dependency Injection |

      _hao

  </title>

  
  <meta charset="utf-8" /><meta name="generator" content="Hugo 0.92.2" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="author" content="_hao" />
  <meta
    name="description"
    content="Life and Tech"
  />
  
  
    
    
    <link
      rel="stylesheet"
      href="https://underscorehao.net/scss/main.min.b2e0cb07595e3519ab1193bb421914e06c0e26b0cc561fef23b3c6131d4d2ffa.css"
      integrity="sha256-suDLB1leNRmrEZO7QhkU4GwOJrDMVh/vI7PGEx1NL/o="
      crossorigin="anonymous"
      type="text/css"
    />

  

  
  <link
    rel="stylesheet"
    href="https://underscorehao.net/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css"
    integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU="
    crossorigin="anonymous"
    type="text/css"
  />
  
  
  <link
    rel="stylesheet"
    href="https://underscorehao.net/fontawesome/css/fontawesome.min.7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f.css"
    integrity="sha256-fSct41tBD7FlN3VQzfnE06gPu8yWHhEZFOTVwOr1cp8="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="https://underscorehao.net/fontawesome/css/solid.min.55d8333481b07a08e07cf6f37319753a2b47e99f4c395394c5747b48b495aa9b.css"
    integrity="sha256-VdgzNIGwegjgfPbzcxl1OitH6Z9MOVOUxXR7SLSVqps="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="https://underscorehao.net/fontawesome/css/regular.min.a7448d02590b43449364b6b5922ed9af5410abb4de4238412a830316dedb850b.css"
    integrity="sha256-p0SNAlkLQ0STZLa1ki7Zr1QQq7TeQjhBKoMDFt7bhQs="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link
    rel="stylesheet"
    href="https://underscorehao.net/fontawesome/css/brands.min.9ed75a5d670c953fe4df935937674b4646f92674367e9e66eb995bb04e821647.css"
    integrity="sha256-ntdaXWcMlT/k35NZN2dLRkb5JnQ2fp5m65lbsE6CFkc="
    crossorigin="anonymous"
    type="text/css"
  />
  
  <link rel="shortcut icon" href="https://underscorehao.net/favicons/favicon.ico" type="image/x-icon" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://underscorehao.net/favicons/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://underscorehao.net/favicons/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="https://underscorehao.net/favicons/favicon-16x16.png" />

  <link rel="canonical" href="https://underscorehao.net/2018/03/net-core-api-dynamodb-dependency-injection/" />

  
  
  
  
  <script
    type="text/javascript"
    src="https://underscorehao.net/js/anatole-header.min.46e6a54097480084f8f52c20ca1aa7425b4fad17029a887fd4017b12e311a72d.js"
    integrity="sha256-RualQJdIAIT49SwgyhqnQltPrRcCmoh/1AF7EuMRpy0="
    crossorigin="anonymous"
  ></script>

  
    
    
    <script
      type="text/javascript"
      src="https://underscorehao.net/js/anatole-theme-switcher.min.5557c8ff5617a01067ac258fd70b9b992506e379317b0da51e5e0f6e018b408a.js"
      integrity="sha256-VVfI/1YXoBBnrCWP1wubmSUG43kxew2lHl4PbgGLQIo="
      crossorigin="anonymous"
    ></script>

  

  


  
  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://underscorehao.net/images/site-feature-image.png"/>

<meta name="twitter:title" content=".NET Core API with DynamoDB Context Dependency Injection"/>
<meta name="twitter:description" content="The Problem Today I faced a problem which I knew would come, but didn&rsquo;t have time to implement properly at the time."/>



  
  <meta property="og:title" content=".NET Core API with DynamoDB Context Dependency Injection" />
<meta property="og:description" content="The Problem Today I faced a problem which I knew would come, but didn&rsquo;t have time to implement properly at the time." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://underscorehao.net/2018/03/net-core-api-dynamodb-dependency-injection/" /><meta property="og:image" content="https://underscorehao.net/images/site-feature-image.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-03-13T22:27:05+02:00" />
<meta property="article:modified_time" content="2018-03-13T22:27:05+02:00" /><meta property="og:site_name" content="Pavel Danov" />




  
  
  
  
  <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "articleSection": "posts",
        "name": ".NET Core API with DynamoDB Context Dependency Injection",
        "headline": ".NET Core API with DynamoDB Context Dependency Injection",
        "alternativeHeadline": "",
        "description": "
      
        The Problem Today I faced a problem which I knew would come, but didn\u0026rsquo;t have time to implement properly at the time.


      


    ",
        "inLanguage": "en",
        "isFamilyFriendly": "true",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/underscorehao.net\/2018\/03\/net-core-api-dynamodb-dependency-injection\/"
        },
        "author" : {
            "@type": "Person",
            "name": "_hao"
        },
        "creator" : {
            "@type": "Person",
            "name": "_hao"
        },
        "accountablePerson" : {
            "@type": "Person",
            "name": "_hao"
        },
        "copyrightHolder" : {
            "@type": "Person",
            "name": "_hao"
        },
        "copyrightYear" : "2018",
        "dateCreated": "2018-03-13T22:27:05.00Z",
        "datePublished": "2018-03-13T22:27:05.00Z",
        "dateModified": "2018-03-13T22:27:05.00Z",
        "publisher":{
            "@type":"Organization",
            "name": "_hao",
            "url": "https://underscorehao.net/",
            "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/underscorehao.net\/favicons\/favicon-32x32.png",
                "width":"32",
                "height":"32"
            }
        },
        "image": 
      [
        
        "https://underscorehao.net/images/site-feature-image.png"


      
      ]

    ,
        "url" : "https:\/\/underscorehao.net\/2018\/03\/net-core-api-dynamodb-dependency-injection\/",
        "wordCount" : "934",
        "genre" : [ 
      
      "Software Development"

    ],
        "keywords" : [ 
      
      "C#"

    
      
        ,

      
      ".NET"

    
      
        ,

      
      "AWS"

    ]
    }
  </script>



</head>
<body
    
      class="body theme--light"

    
  >
    <div class="wrapper">
      <aside
        
          class="wrapper__sidebar"

        
      ><div
  class="sidebar
    animated fadeInDown

  "
>
  <div class="sidebar__content">
    <div class="sidebar__introduction">
      <img
        class="sidebar__introduction-profileimage"
        src="https://underscorehao.net/images/avatar.jpg"
        alt="profile picture"
      />
      
        <div class="sidebar__introduction-title">
          <a href="https://underscorehao.net/">Pavel Danov</a>
        </div>

      
      <div class="sidebar__introduction-description">
        <p>Life and Tech</p>
      </div>
    </div>
    <ul class="sidebar__list">
      
        <li class="sidebar__list-item">
          <a
            href="https://twitter.com/underscoreHao/"
            target="_blank"
            rel="noopener"
            aria-label="Twitter"
            title="Twitter"
          >
            <i class="fab fa-twitter fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li class="sidebar__list-item">
          <a
            href="https://github.com/underscoreHao/"
            target="_blank"
            rel="noopener"
            aria-label="GitHub"
            title="GitHub"
          >
            <i class="fab fa-github fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li class="sidebar__list-item">
          <a
            href="https://stackoverflow.com/users/2265179/underscorehao"
            target="_blank"
            rel="noopener"
            aria-label="Stack Overflow"
            title="Stack Overflow"
          >
            <i class="fab fa-stack-overflow fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li class="sidebar__list-item">
          <a
            href="https://news.ycombinator.com/user?id=_hao"
            target="_blank"
            rel="noopener"
            aria-label="Hacker News"
            title="Hacker News"
          >
            <i class="fab fa-hacker-news fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li class="sidebar__list-item">
          <a
            href="mailto:underscorehao@gmail.com"
            target="_blank"
            rel="noopener"
            aria-label="e-mail"
            title="e-mail"
          >
            <i class="fas fa-envelope fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
        <li class="sidebar__list-item">
          <a
            href="https://underscorehao.net/index.xml"
            target="_blank"
            rel="noopener"
            aria-label="RSS"
            title="RSS"
          >
            <i class="fas fa-rss fa-2x" aria-hidden="true"></i>
          </a>
        </li>

      
    </ul>
  </div><footer class="footer footer__sidebar">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        2017-2022

      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="https://underscorehao.net/js/medium-zoom.min.fae9ac8895995fe91958b3954be11e96025824a04770726a3531e119ddd2d576.js"
    integrity="sha256-&#43;umsiJWZX&#43;kZWLOVS&#43;EelgJYJKBHcHJqNTHhGd3S1XY="
    crossorigin="anonymous"
  ></script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-106583563-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
</div>
</aside>
      <main
        
          class="wrapper__main"

        
      >
        <header class="header"><div
  class="
    animated fadeInDown

  "
>
  <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
    <span aria-hidden="true" class="navbar-burger__line"></span>
  </a>
  <nav class="nav">
    <ul class="nav__list" id="navMenu">
      
      
        
        
          <li class="nav__list-item">
            <a
              
              href="https://underscorehao.net/"
              
              title=""
              >Home</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="https://underscorehao.net/posts/"
              
              title=""
              >Blog</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="https://underscorehao.net/about/"
              
              title=""
              >About</a
            >
          </li>

        


      
        
        
          <li class="nav__list-item">
            <a
              
              href="https://underscorehao.net/contact/"
              
              title=""
              >Contact</a
            >
          </li>

        


      
    </ul>
    <ul class="nav__list nav__list--end">
      
      
        <li class="nav__list-item">
          <div class="themeswitch">
            <a title="Switch Theme">
              <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
          </div>
        </li>

      
    </ul>
  </nav>
</div>
</header>
  <div
    class="post 
      animated fadeInDown

    "
  >
    
    <div class="post__content">
      <h1>.NET Core API With DynamoDB Context Dependency Injection</h1>
      <h2 id="the-problem">The Problem</h2>
<p>Today I faced a problem which I knew would come, but didn&rsquo;t have time to implement properly at the time. There were more urgent tasks at hand before, deadlines to be met and this issue remained unresolved.</p>
<p>Amazon&rsquo;s .NET Core SDK is very good for the most part. Everything works as it should. But let&rsquo;s say you use the <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DotNetSDKHighLevel.html">.NET Object Persistence Model</a> for <a href="https://aws.amazon.com/dynamodb/">DynamoDB</a> in your service and you have mapped C# classes to DynamoDB tables like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">namespace</span> <span class="nn">Models</span>
<span class="p">{</span>
<span class="na">    [DynamoDBTable(&#34;Player&#34;)]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Player</span>
    <span class="p">{</span>
<span class="na">        [DynamoDBHashKey]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="na">
</span><span class="na">        [DynamoDBProperty]</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="na">
</span><span class="na">        [DynamoDBProperty]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">HitPoints</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="na">
</span><span class="na">        [DynamoDBProperty]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Gold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="na">
</span><span class="na">        [DynamoDBProperty]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Level</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="na">
</span><span class="na">        [DynamoDBProperty]</span>
        <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">Items</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="na">
</span><span class="na">    [DynamoDBTable(&#34;Location&#34;)]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">Location</span>
    <span class="p">{</span>
<span class="na">        [DynamoDBHashKey]</span>
        <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="na">
</span><span class="na">        [DynamoDBProperty]</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="na">
</span><span class="na">        [DynamoDBProperty]</span>
        <span class="k">public</span> <span class="kt">string</span> <span class="n">Description</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>It works well. Everything is mapped as it should. You have a service that calls the .NET SDK so you can write, read and delete data from the context like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">namespace</span> <span class="nn">Services</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">DynamoDbService</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kt">string</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">DynamoDBContext</span> <span class="n">context</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DynamoDBContext</span><span class="p">(</span><span class="m">_d</span><span class="n">ynamoDbClient</span><span class="p">);</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">LoadAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">id</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="p">(</span><span class="s">$&#34;Amazon error in Get operation! Error: {ex}&#34;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">WriteAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">DynamoDBContext</span> <span class="n">context</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DynamoDBContext</span><span class="p">(</span><span class="m">_d</span><span class="n">ynamoDbClient</span><span class="p">);</span>
                <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">SaveAsync</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="p">(</span><span class="s">$&#34;Amazon error in Write operation! Error: {ex}&#34;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">DeleteAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="n">DynamoDBContext</span> <span class="n">context</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DynamoDBContext</span><span class="p">(</span><span class="m">_d</span><span class="n">ynamoDbClient</span><span class="p">);</span>
                <span class="k">await</span> <span class="n">context</span><span class="p">.</span><span class="n">DeleteAsync</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="p">(</span><span class="s">$&#34;Amazon error in Delete operation! Error: {ex}&#34;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>It&rsquo;s all fun and games until you have to use different databases for different environments! Of course you can use the <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DotNetSDKMidLevel.html">Document Model</a>, but then you lose the nice mapping to C# classes and have to work with generic documents.</p>
<p>C# attributes are not meant to change at runtime, so we&rsquo;re in a tough spot! What can we do to tell our build pipeline which tables we&rsquo;d like to use?</p>
<h2 id="the-solution">The Solution</h2>
<p>.NET Core&rsquo;s powerful dependency injection comes to our rescue! First we create the same section (with the respective databases for our environments) in our <strong><code>appsettings.Development.json</code></strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="s2">&#34;DynamoDbTables&#34;</span><span class="err">:</span> <span class="p">{</span>
    <span class="nt">&#34;Player&#34;</span><span class="p">:</span> <span class="s2">&#34;DevPlayer&#34;</span><span class="p">,</span>
    <span class="nt">&#34;Location&#34;</span><span class="p">:</span> <span class="s2">&#34;DevLocation&#34;</span>
<span class="p">}</span>
</code></pre></div><p>and <strong><code>appsettings.json</code></strong> file</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="s2">&#34;DynamoDbTables&#34;</span><span class="err">:</span> <span class="p">{</span>
    <span class="nt">&#34;Player&#34;</span><span class="p">:</span> <span class="s2">&#34;ProdPlayer&#34;</span><span class="p">,</span>
    <span class="nt">&#34;Location&#34;</span><span class="p">:</span> <span class="s2">&#34;ProdLocation&#34;</span>
<span class="p">}</span>
</code></pre></div><p>Then we head up and create a simple configuration class which we&rsquo;ll bind to our DynamoDbTables JSON object later</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">DynamoDbOptions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Player</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Location</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>After that we have to create our custom DynamoDb context interface</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">interface</span> <span class="n">IDynamoDbContext</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">IDisposable</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
<span class="p">{</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetByIdAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">);</span>
    <span class="n">Task</span> <span class="n">SaveAsync</span><span class="p">(</span><span class="n">T</span> <span class="n">item</span><span class="p">);</span>
    <span class="n">Task</span> <span class="n">DeleteByIdAsync</span><span class="p">(</span><span class="n">T</span> <span class="n">item</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>and the context class which we&rsquo;ll inject in our services</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">DynamoDbContext</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">DynamoDBContext</span><span class="p">,</span> <span class="n">IDynamoDbContext</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
    <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="k">class</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">DynamoDBOperationConfig</span> <span class="m">_</span><span class="n">config</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">DynamoDbContext</span><span class="p">(</span><span class="n">IAmazonDynamoDB</span> <span class="n">client</span><span class="p">,</span> <span class="kt">string</span> <span class="n">tableName</span><span class="p">)</span>
        <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="m">_</span><span class="n">config</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DynamoDBOperationConfig</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">OverrideTableName</span> <span class="p">=</span> <span class="n">tableName</span>
        <span class="p">};</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">GetByIdAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">await</span> <span class="k">base</span><span class="p">.</span><span class="n">LoadAsync</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">id</span><span class="p">,</span> <span class="m">_</span><span class="n">config</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">SaveAsync</span><span class="p">(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="k">base</span><span class="p">.</span><span class="n">SaveAsync</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="m">_</span><span class="n">config</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">DeleteByIdAsync</span><span class="p">(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">await</span> <span class="k">base</span><span class="p">.</span><span class="n">DeleteAsync</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="m">_</span><span class="n">config</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Then we go to our <strong><code>Startup.cs</code></strong> and add a couple of lines to our <strong><code>ConfigureServices()</code></strong> method</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="c1">// AWS Options
</span><span class="c1"></span><span class="kt">var</span> <span class="n">awsOptions</span> <span class="p">=</span> <span class="n">Configuration</span><span class="p">.</span><span class="n">GetAWSOptions</span><span class="p">();</span>
<span class="n">services</span><span class="p">.</span><span class="n">AddDefaultAWSOptions</span><span class="p">(</span><span class="n">awsOptions</span><span class="p">);</span>

<span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="n">awsOptions</span><span class="p">.</span><span class="n">CreateServiceClient</span><span class="p">&lt;</span><span class="n">IAmazonDynamoDB</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">dynamoDbOptions</span> <span class="p">=</span> <span class="k">new</span> <span class="n">DynamoDbOptions</span><span class="p">();</span>
<span class="n">ConfigurationBinder</span><span class="p">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">Configuration</span><span class="p">.</span><span class="n">GetSection</span><span class="p">(</span><span class="s">&#34;DynamoDbTables&#34;</span><span class="p">),</span> <span class="n">dynamoDbOptions</span><span class="p">);</span>

<span class="c1">// This is where the magic happens
</span><span class="c1"></span><span class="n">services</span><span class="p">.</span><span class="n">AddScoped</span><span class="p">&lt;</span><span class="n">IDynamoDbContext</span><span class="p">&lt;</span><span class="n">Player</span><span class="p">&gt;&gt;(</span><span class="n">provider</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">DynamoDbContext</span><span class="p">&lt;</span><span class="n">Player</span><span class="p">&gt;(</span><span class="n">client</span><span class="p">,</span> <span class="n">dynamoDbOptions</span><span class="p">.</span><span class="n">Player</span><span class="p">));</span>
<span class="n">services</span><span class="p">.</span><span class="n">AddScoped</span><span class="p">&lt;</span><span class="n">IDynamoDbContext</span><span class="p">&lt;</span><span class="n">Location</span><span class="p">&gt;&gt;(</span><span class="n">provider</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">DynamoDbContext</span><span class="p">&lt;</span><span class="n">Location</span><span class="p">&gt;(</span><span class="n">client</span><span class="p">,</span> <span class="n">dynamoDbOptions</span><span class="p">.</span><span class="n">Location</span><span class="p">));</span>
</code></pre></div><p>And voil√†! We can now remove the <strong><code>[DynamoDBTable(&quot;SomeTableName&quot;)]</code></strong> attributes from our classes. We can keep both <strong><code>[DynamoDBHashKey]</code></strong> and <strong><code>[DynamoDBProperty]</code></strong> attributes. If we need custom converters we can just add <strong><code>[DynamoDBProperty(typeof(SomeConverter))]</code></strong> attribute to our property.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="c1">// No table name attribute needed!
</span><span class="c1"></span><span class="k">public</span> <span class="k">class</span> <span class="nc">Player</span>
<span class="p">{</span>
<span class="na">    [DynamoDBHashKey]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="na">
</span><span class="na">    [DynamoDBProperty]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="na">
</span><span class="na">    [DynamoDBProperty]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">HitPoints</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="na">
</span><span class="na">    [DynamoDBProperty]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Gold</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="na">
</span><span class="na">    [DynamoDBProperty]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Level</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="na">
</span><span class="na">    [DynamoDBProperty]</span>
    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">Items</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// No table name attribute needed!
</span><span class="c1"></span><span class="k">public</span> <span class="k">class</span> <span class="nc">Location</span>
<span class="p">{</span>
<span class="na">    [DynamoDBHashKey]</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="na">
</span><span class="na">    [DynamoDBProperty]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="na">
</span><span class="na">    [DynamoDBProperty]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Description</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>and we can use the desired context with their respective tables in our services!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">namespace</span> <span class="nn">Services</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">AwesomeDynamoDbService</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="n">IDynamoDbContext</span><span class="p">&lt;</span><span class="n">Player</span><span class="p">&gt;</span> <span class="m">_</span><span class="n">playerContext</span><span class="p">;</span>
        <span class="k">private</span> <span class="n">IDynamoDbContext</span><span class="p">&lt;</span><span class="n">Location</span><span class="p">&gt;</span> <span class="m">_l</span><span class="n">ocationContext</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">AwesomeDynamoDbService</span><span class="p">(</span><span class="n">IDynamoDbContext</span><span class="p">&lt;</span><span class="n">Player</span><span class="p">&gt;</span> <span class="n">playerContext</span><span class="p">,</span> <span class="n">IDynamoDbContext</span><span class="p">&lt;</span><span class="n">Location</span><span class="p">&gt;</span> <span class="n">locationContext</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="m">_</span><span class="n">playerContext</span> <span class="p">=</span> <span class="n">playerContext</span><span class="p">;</span>
            <span class="m">_l</span><span class="n">ocationContext</span> <span class="p">=</span> <span class="n">locationContext</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">User</span><span class="p">&gt;</span> <span class="n">GetUserAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">await</span> <span class="m">_</span><span class="n">playerContext</span><span class="p">.</span><span class="n">GetByIdAsync</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="p">(</span><span class="s">$&#34;Amazon error in GetUser table operation! Error: {ex}&#34;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Location</span><span class="p">&gt;</span> <span class="n">GetLocationAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">await</span> <span class="m">_l</span><span class="n">ocationContext</span><span class="p">.</span><span class="n">GetByIdAsync</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">Exception</span><span class="p">(</span><span class="s">$&#34;Amazon error in GetLocation table operation! Error: {ex}&#34;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Depending on your case you can use different services for different tables or other requirements. This solution might seem a bit more cumbersome than the original, but it makes us flexible in case we need to work with multiple databases and different build environments. The only thing you have to do is to tell your build tool/pipeline to change the table names in your <strong><code>appsettings.json</code></strong> files.</p>
<p>This method also is more robust when it comes to testing because it&rsquo;ll be much easier to mock! All in all I&rsquo;m really happy with how it all turned out!</p>
</div>
    <div class="post__footer">
      
        <span><a class="category" href="https://underscorehao.net/categories/software-development/">Software Development</a></span>




      

      
        <span><a class="tag" href="https://underscorehao.net/tags/c%23/">C#</a><a class="tag" href="https://underscorehao.net/tags/%2enet/">.NET</a><a class="tag" href="https://underscorehao.net/tags/aws/">AWS</a></span>




      
    </div>

    
  </div>


      </main>
    </div><footer class="footer footer__base">
  <ul class="footer__list">
    <li class="footer__item">
      &copy;
      
        2017-2022

      
    </li>
    
  </ul>
</footer>
  
  <script
    type="text/javascript"
    src="https://underscorehao.net/js/medium-zoom.min.fae9ac8895995fe91958b3954be11e96025824a04770726a3531e119ddd2d576.js"
    integrity="sha256-&#43;umsiJWZX&#43;kZWLOVS&#43;EelgJYJKBHcHJqNTHhGd3S1XY="
    crossorigin="anonymous"
  ></script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-106583563-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
</body>
</html>
