<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">

    <meta name="author" content="Pavel Danov">
    <meta name="description" content="Caching is hard On a bright sunny day while you&#39;re working on your awesome project you catch a glimpse of something. You bring yourself closer to the monitor and begin meticulously examining your code. What you find brings you feelings of disgust and shame! You&#39;ve been calling an API retrieving data you need over and over again even though said data hardly changes!
Being the smart and responsible engineer that you are, you decide to rectify your mistake immediately.">
    <meta name="keywords" content="blog,developer,personal,back-end,c#,c&#43;&#43;,programming,software,tech,backend,fintech,gamedev,games">

    

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Auto Refreshing Cache in .NET"/>
<meta name="twitter:description" content="Caching is hard On a bright sunny day while you&#39;re working on your awesome project you catch a glimpse of something. You bring yourself closer to the monitor and begin meticulously examining your code. What you find brings you feelings of disgust and shame! You&#39;ve been calling an API retrieving data you need over and over again even though said data hardly changes!
Being the smart and responsible engineer that you are, you decide to rectify your mistake immediately."/>

    <meta property="og:title" content="Auto Refreshing Cache in .NET" />
<meta property="og:description" content="Caching is hard On a bright sunny day while you&#39;re working on your awesome project you catch a glimpse of something. You bring yourself closer to the monitor and begin meticulously examining your code. What you find brings you feelings of disgust and shame! You&#39;ve been calling an API retrieving data you need over and over again even though said data hardly changes!
Being the smart and responsible engineer that you are, you decide to rectify your mistake immediately." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://underscorehao.net/2019/07/auto-refreshing-cache-in-dotnet/" />
<meta property="article:published_time" content="2019-07-11T22:47:02+01:00" />
<meta property="article:modified_time" content="2019-07-11T22:47:02+01:00" />


    
      <base href="https://underscorehao.net/2019/07/auto-refreshing-cache-in-dotnet/">
    
    <title>
Auto Refreshing Cache in .NET Â· _hao
</title>

    
      <link rel="canonical" href="https://underscorehao.net/2019/07/auto-refreshing-cache-in-dotnet/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css" integrity="sha384-Bfad6CLCknfcloXFOyFnlgtENryhrpZCe29RTifKEixXQZ38WheV+i/6YWSzkz3V" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://underscorehao.net/css/coder.min.3219ef62ae52679b7a9c19043171c3cd9f523628c2a65f3ef247ee18836bc90b.css" integrity="sha256-MhnvYq5SZ5t6nBkEMXHDzZ9SNijCpl8&#43;8kfuGINryQs=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="https://underscorehao.net/css/coder-dark.min.e78e80fc3a585a4d1c8fc7f58623b6ff852411e38431a9cd1792877ecaa160f6.css" integrity="sha256-546A/DpYWk0cj8f1hiO2/4UkEeOEManNF5KHfsqhYPY=" crossorigin="anonymous" media="screen" />
      
    

    
      <link rel="stylesheet" href="https://underscorehao.net/css/custom.css" />
    
      <link rel="stylesheet" href="https://underscorehao.net/css/syntax.css" />
    

    

    <link rel="icon" type="image/png" href="https://underscorehao.net/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://underscorehao.net/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.62.2" />
  </head>

  
  
    
  
  <body class="colorscheme-dark"
        onload=""
  >
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://underscorehao.net/">
      _hao
    </a>
    
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://underscorehao.net/posts/">Blog</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://underscorehao.net/about/">About</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://underscorehao.net/contact/">Contact</a>
          </li>
        
      
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
<section class="container post">
  <article>
    <header>
      <div class="post-title">
        <h1 class="title">Auto Refreshing Cache in .NET</h1>
      </div>
      <div class="post-meta">
        <div class="date">
          <span class="posted-on">
            <i class="fas fa-calendar"></i>
            <time datetime='2019-07-11T22:47:02&#43;01:00'>
              July 11, 2019
            </time>
          </span>
          <span class="reading-time">
            <i class="fas fa-clock"></i>
            10-minute read
          </span>
        </div>
        
        
      </div>
    </header>

    <div>
      

      
      <h2 id="caching-is-hard">Caching is hard</h2>
<p>On a bright sunny day while you're working on your awesome project you catch a glimpse of something. You bring yourself closer to the monitor and begin meticulously examining your code. What you find brings you feelings of disgust and shame! You've been calling an API retrieving data you need over and over again even though said data hardly changes!</p>
<p>Being the smart and responsible engineer that you are, you decide to rectify your mistake immediately. You think to yourself</p>
<blockquote>
<p>&quot;OK, I'll just implement caching around that piece of data and I'm done!&rdquo;</p>
</blockquote>
<p>Not so fast! Little do you know that you're opening the gates of your own small personal hell!</p>
<h2 id="caching-in-net">Caching in .NET</h2>
<p>The little story above is a <em>slight</em> exaggeration, but caching is indeed a touchy subject. It's a nice performance boost when done right, but it can also lead you to a dark path filled with scary monsters and unforeseen problems.</p>
<p>There are many articles written on caching in .NET, you should read the official docs and perhaps other articles written by the good people on the Internet.</p>
<p>This article however will deal with a very specific caching problem. How can you implement a cache that is refreshing itself after a specific amount of time with the following characteristics:</p>
<ul>
<li>Thread safety</li>
<li>Not getting any cache misses (even if that means we're returning stale data)</li>
</ul>
<p>If that's what you need, keep on reading!</p>
<h2 id="implementation-with-memorycache-in-net-framework">Implementation with MemoryCache in .NET Framework</h2>
<p>Let's start with the simple stuff. We want to perform some basic CRUD operations on our cache - saving data to it, getting our cached objects and potentially deleting our data. The best way to do it is to define an interface.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System.Runtime.Caching</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">FooBar.Caching</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">interface</span> <span class="n">IMemoryAutoRefreshCache</span>
    <span class="p">{</span>
        <span class="n">T</span> <span class="n">GetById</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">)</span><span class="p">;</span>
        <span class="k">void</span> <span class="n">Save</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">,</span> <span class="n">T</span> <span class="n">cacheObj</span><span class="p">,</span> <span class="n">CacheItemPolicy</span> <span class="n">refreshPolicy</span><span class="p">)</span><span class="p">;</span>
        <span class="k">void</span> <span class="n">Remove</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>These are the methods I'm going to use to illustrate my example. Depending on your use case you can have a lot more of them doing various things to your cache, but for my case those are enough. The point I want you to focus on here is the <strong><code>CacheItemPolicy</code></strong> we can set during the Save.</p>
<p>Now that we have our interface we can also implement it in a new class</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System.Runtime.Caching</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">FooBar.Caching</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MemoryAutoRefreshCache</span> <span class="p">:</span> <span class="n">IMemoryAutoRefreshCache</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">MemoryCache</span> <span class="n">memoryCache</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">MemoryAutoRefreshCache</span><span class="p">(</span><span class="n">MemoryCache</span> <span class="n">memoryCache</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">memoryCache</span> <span class="p">=</span> <span class="n">memoryCache</span> <span class="p">?</span><span class="p">?</span> <span class="n">MemoryCache</span><span class="p">.</span><span class="n">Default</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">T</span> <span class="n">GetById</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="k">value</span> <span class="p">=</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="n">memoryCache</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">value</span> <span class="p">=</span><span class="p">=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">default</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">value</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="n">Save</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">,</span> <span class="n">T</span> <span class="n">result</span><span class="p">,</span> <span class="n">CacheItemPolicy</span> <span class="n">refreshPolicy</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">memoryCache</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">refreshPolicy</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="n">Remove</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">memoryCache</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Nothing out of the ordinary here. I want to bring your attention to our <strong><code>Save</code></strong> method one more time and the CacheItemPolicy. The summary of <strong><code>CacheItemPolicy</code></strong> states:</p>
<blockquote>
<p>Represents a set of eviction and expiration details for a specific cache entry.</p>
</blockquote>
<p>Inside the <strong><code>CacheItemPolicy</code></strong> we have two callbacks which will give us everything we need to accomplish our task.</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.caching.cacheentryremovedcallback?view=netframework-4.8"><strong><code>RemovedCallback</code></strong></a> - Occurs <strong><em>after</em></strong> the item has been removed</li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.caching.cacheentryupdatecallback?view=netframework-4.8"><strong><code>UpdateCallback</code></strong></a> - Occurs <strong><em>before</em></strong> the item is removed</li>
</ul>
<p>As you can imagine we'll use the <strong><code>UpdateCallback</code></strong> in our case.</p>
<p>So let's see how an implementation of this auto refreshing cache will look like!</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Caching</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">FooBar.Caching</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">FooBar.Services.Configuration</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ConfigurationProvider</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMemoryAutoRefreshCache</span> <span class="n">localCache</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">cacheKey</span> <span class="p">=</span> <span class="s">&#34;myAwesomeCacheKey&#34;</span><span class="p">;</span>

        <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">object</span> <span class="n">_lock</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">ConfigurationProvider</span><span class="p">(</span><span class="n">ILocalAutoRefreshCache</span> <span class="n">localCache</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">localCache</span> <span class="p">=</span> <span class="n">localCache</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">Configuration</span> <span class="n">GetConfiguration</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">cachedConfig</span> <span class="p">=</span> <span class="n">localCache</span><span class="p">.</span><span class="n">GetById</span><span class="p">&lt;</span><span class="n">Configuration</span><span class="p">&gt;</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">)</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cachedConfig</span> <span class="p">!</span><span class="p">=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">cachedConfig</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">lock</span> <span class="p">(</span><span class="n">_lock</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Check to see if anyone wrote in the cache while we&#39;re waiting for our turn
</span><span class="c1"></span>                <span class="n">cachedConfig</span> <span class="p">=</span> <span class="n">localCache</span><span class="p">.</span><span class="n">GetById</span><span class="p">&lt;</span><span class="n">Configuration</span><span class="p">&gt;</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">)</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cachedConfig</span> <span class="p">!</span><span class="p">=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="n">cachedConfig</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="c1">// This method is not implemented because it can be anything. The main part is that you want to cache an object.
</span><span class="c1"></span>                <span class="n">cachedConfig</span> <span class="p">=</span> <span class="n">GetConfigurationFromRemoteLocation</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span><span class="p">;</span>
                <span class="kt">int</span> <span class="n">refreshTimeInSeconds</span> <span class="p">=</span> <span class="m">3</span><span class="m">6</span><span class="m">0</span><span class="m">0</span><span class="p">;</span> <span class="c1">// 1 hour
</span><span class="c1"></span>                <span class="n">localCache</span><span class="p">.</span><span class="n">Save</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span> <span class="n">cachedConfig</span><span class="p">,</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="n">refreshTimeInSeconds</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

                <span class="k">return</span> <span class="n">cachedConfig</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">CacheItemPolicy</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="kt">int</span> <span class="n">refreshInterval</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CacheItemPolicy</span>
            <span class="p">{</span>
                <span class="c1">// This is where the magic happens
</span><span class="c1"></span>                <span class="c1">// The UpdateCallback will be called before our object is removed from the cache
</span><span class="c1"></span>                <span class="n">UpdateCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">CacheEntryUpdateArguments</span> <span class="n">args</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">RemovedReason</span> <span class="p">=</span><span class="p">=</span> <span class="n">CacheEntryRemovedReason</span><span class="p">.</span><span class="n">Expired</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="kt">var</span> <span class="n">cacheKey</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Key</span><span class="p">;</span>

                        <span class="c1">// Get current cached value
</span><span class="c1"></span>                        <span class="kt">var</span> <span class="n">currentCachedEntity</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Source</span><span class="p">[</span><span class="n">cacheKey</span><span class="p">]</span> <span class="k">as</span> <span class="n">Configuration</span><span class="p">;</span>

                        <span class="c1">// Get the potentially new data
</span><span class="c1"></span>                        <span class="kt">var</span> <span class="n">newEntity</span> <span class="p">=</span> <span class="n">GetConfigurationFromRemoteLocation</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span><span class="p">;</span>

                        <span class="c1">// If new is not null - update, otherwise just refresh the old value
</span><span class="c1"></span>                        <span class="c1">// The condition by which you decide to update or refresh the data depends entirely on you
</span><span class="c1"></span>                        <span class="k">if</span> <span class="p">(</span><span class="n">newEntity</span> <span class="p">!</span><span class="p">=</span> <span class="k">null</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="kt">var</span> <span class="n">updatedEntity</span> <span class="p">=</span> <span class="n">newEntity</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItem</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CacheItem</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span> <span class="n">updatedEntity</span><span class="p">)</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItemPolicy</span> <span class="p">=</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span>
                        <span class="p">{</span>
                            <span class="kt">var</span> <span class="n">updatedEntity</span> <span class="p">=</span> <span class="n">currentCachedEntity</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItem</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CacheItem</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span> <span class="n">updatedEntity</span><span class="p">)</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItemPolicy</span> <span class="p">=</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span><span class="p">,</span>
                <span class="n">AbsoluteExpiration</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">.</span><span class="n">AddSeconds</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span><span class="p">,</span>
            <span class="p">}</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>So there you go! Now you can refresh, update or invalidate your cache every hour depending on the behavior you desire!</p>
<h3 id="bonus">Bonus</h3>
<p>As a bonus you can read on the interesting thing that happens when you put <strong><code>AbsoluteExpiration</code></strong> below 20 seconds <a href="https://stackoverflow.com/questions/12630168/memorycache-absoluteexpiration-acting-strange">here</a>.</p>
<p>Also it's important to note that items can expire some time after the AbsoluteExpiration, there's no guarantee that they'll expire right on the spot. Here are two tests confirming that (I know we shouldn't test code that isn't ours, but it's fun!)</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">FooBar.Caching</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">NUnit.Framework</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Caching</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">FooBar.Caching.UnitTests</span>
<span class="p">{</span>
<span class="na">    [TestFixture]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MemoryAutoRefreshCacheTests</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="n">MemoryAutoRefreshCache</span> <span class="n">subject</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">int</span> <span class="n">updateItemCounter</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
<span class="na">
</span><span class="na">        [SetUp]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="n">Setup</span><span class="p">(</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span> <span class="n">subject</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryAutoRefreshCache</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="na">
</span><span class="na">        [Test]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">VerifyUpdateCallback_LocalMemoryCache</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">updateItemCounter</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

            <span class="n">subject</span><span class="p">.</span><span class="n">Save</span><span class="p">(</span><span class="s">$&#34;key&#34;</span><span class="p">,</span> <span class="s">&#34;value&#34;</span><span class="p">,</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

            <span class="c1">// The item can be expired between 0 and 30 seconds after expiration time
</span><span class="c1"></span>            <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">3</span><span class="m">2</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

            <span class="c1">// Test that the update callback was invoked at least once
</span><span class="c1"></span>            <span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">updateItemCounter</span> <span class="p">&gt;</span><span class="p">=</span> <span class="m">1</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
<span class="na">
</span><span class="na">        [Test]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="n">VerifyUpdateCallbackReturnsDuringRefresh_LocalMemoryCache</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">updateItemCounter</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

            <span class="kt">string</span> <span class="n">key</span> <span class="p">=</span> <span class="s">&#34;key&#34;</span><span class="p">;</span>
            <span class="kt">string</span> <span class="k">value</span> <span class="p">=</span> <span class="s">&#34;value&#34;</span><span class="p">;</span>

            <span class="n">subject</span><span class="p">.</span><span class="n">Save</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">GetPolicyWithDelay</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

            <span class="c1">// The item can be expired between 0 and 30 seconds after expiration time
</span><span class="c1"></span>            <span class="kt">var</span> <span class="n">start</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>

            <span class="k">do</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">cachedItem</span> <span class="p">=</span> <span class="n">subject</span><span class="p">.</span><span class="n">GetById</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span><span class="p">(</span><span class="s">&#34;key&#34;</span><span class="p">)</span><span class="p">;</span>
                <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="k">value</span><span class="p">,</span> <span class="n">cachedItem</span><span class="p">)</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">start</span><span class="p">.</span><span class="n">AddSeconds</span><span class="p">(</span><span class="m">4</span><span class="m">0</span><span class="p">)</span> <span class="p">&gt;</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">)</span><span class="p">;</span>

            <span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">updateItemCounter</span> <span class="p">&gt;</span><span class="p">=</span> <span class="m">1</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="kt">string</span> <span class="n">AddKeys</span><span class="p">(</span><span class="kt">string</span> <span class="n">key</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">updateItemCounter</span><span class="p">+</span><span class="p">+</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">key</span> <span class="p">+</span> <span class="n">key</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="n">UpdateCounter</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">updateItemCounter</span><span class="p">+</span><span class="p">+</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">CacheItemPolicy</span> <span class="n">GetPolicyWithDelay</span><span class="p">(</span><span class="kt">double</span> <span class="n">refreshInterval</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CacheItemPolicy</span>
            <span class="p">{</span>
                <span class="n">UpdateCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">CacheEntryUpdateArguments</span> <span class="n">args</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">RemovedReason</span> <span class="p">=</span><span class="p">=</span> <span class="n">CacheEntryRemovedReason</span><span class="p">.</span><span class="n">Expired</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">2</span><span class="m">0</span><span class="m">0</span><span class="m">0</span><span class="p">)</span><span class="p">;</span>
                        <span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Key</span><span class="p">;</span>

                        <span class="c1">// Get current cached value
</span><span class="c1"></span>                        <span class="kt">var</span> <span class="n">currentCachedEntity</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Source</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="k">as</span> <span class="kt">string</span><span class="p">;</span>
                        <span class="n">UpdateCounter</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

                        <span class="kt">var</span> <span class="n">newEntity</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Source</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="p">;</span>

                        <span class="c1">// If new is not null - update, otherwise just refresh the old value
</span><span class="c1"></span>                        <span class="k">if</span> <span class="p">(</span><span class="n">newEntity</span> <span class="p">!</span><span class="p">=</span> <span class="k">null</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="kt">var</span> <span class="n">updatedEntity</span> <span class="p">=</span> <span class="n">newEntity</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItem</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CacheItem</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">updatedEntity</span><span class="p">)</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItemPolicy</span> <span class="p">=</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span>
                        <span class="p">{</span>
                            <span class="kt">var</span> <span class="n">updatedEntity</span> <span class="p">=</span> <span class="n">currentCachedEntity</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItem</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CacheItem</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">updatedEntity</span><span class="p">)</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItemPolicy</span> <span class="p">=</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span><span class="p">;</span>
                        <span class="p">}</span>

                    <span class="p">}</span>
                <span class="p">}</span><span class="p">,</span>
                <span class="n">AbsoluteExpiration</span> <span class="p">=</span> <span class="n">DateTimeOffset</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">.</span><span class="n">AddSeconds</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span>
            <span class="p">}</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">CacheItemPolicy</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="kt">double</span> <span class="n">refreshInterval</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CacheItemPolicy</span>
            <span class="p">{</span>
                <span class="n">UpdateCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">CacheEntryUpdateArguments</span> <span class="n">args</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">RemovedReason</span> <span class="p">=</span><span class="p">=</span> <span class="n">CacheEntryRemovedReason</span><span class="p">.</span><span class="n">Expired</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Key</span><span class="p">;</span>

                        <span class="c1">// Get current cached value
</span><span class="c1"></span>                        <span class="kt">var</span> <span class="n">currentCachedEntity</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Source</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="k">as</span> <span class="kt">string</span><span class="p">;</span>

                        <span class="kt">var</span> <span class="n">newEntity</span> <span class="p">=</span> <span class="n">AddKeys</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="p">;</span>

                        <span class="c1">// If new is not null - update, otherwise just refresh the old value
</span><span class="c1"></span>                        <span class="k">if</span> <span class="p">(</span><span class="n">newEntity</span> <span class="p">!</span><span class="p">=</span> <span class="k">null</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="kt">var</span> <span class="n">updatedEntity</span> <span class="p">=</span> <span class="n">newEntity</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItem</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CacheItem</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">updatedEntity</span><span class="p">)</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItemPolicy</span> <span class="p">=</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span>
                        <span class="p">{</span>
                            <span class="kt">var</span> <span class="n">updatedEntity</span> <span class="p">=</span> <span class="n">currentCachedEntity</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItem</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CacheItem</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">updatedEntity</span><span class="p">)</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItemPolicy</span> <span class="p">=</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span><span class="p">;</span>
                        <span class="p">}</span>

                    <span class="p">}</span>
                <span class="p">}</span><span class="p">,</span>
                <span class="n">SlidingExpiration</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span><span class="p">,</span>
            <span class="p">}</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h2 id="implementation-with-imemorycache-in-net-core">Implementation with IMemoryCache in .NET Core</h2>
<p>I have a strong feeling a lot of people will come to read this article for the part that follows&hellip; Who cares about .NET Framework, amirite?! It's all about .NET Core nowadays, son!</p>
<p>I'd be lying if I didn't say that I prefer the .NET Core implementation. But I digress. Let's stay on the issue at hand - implementing an auto refreshing cache.</p>
<p>We still have access to <strong><code>MemoryCache</code></strong> in .NET Core. However it only provides a callback which will execute <strong><em>after</em></strong> an item has been <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.caching.memory.memorycacheentryoptions.postevictioncallbacks?view=aspnetcore-2.2#Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_PostEvictionCallbacks">removed</a>. That doesn't matter for our use case. Remember what we said at the start. We don't care if we get stale data as long as there are no cache misses! To achieve the same thing we did in the previous section we are going to use a shiny new interface called <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.caching.memory.imemorycache?view=aspnetcore-2.2"><strong><code>IMemoryCache</code></strong></a>. And guess what! It's provided by Microsoft too!</p>
<p>The code is more or less the same with some differences when it comes to the locking. This time we're performing operations inside an async method so we can't use a regular lock. For the sake of completeness I'll provide the full implementation + tests and gotchas after.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Concurrent</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Caching.Memory</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">FooBar.Providers</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">SettingsStore</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">cacheKey</span> <span class="p">=</span> <span class="s">&#34;FooBarPrivateKey&#34;</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">refreshTimeInSeconds</span> <span class="p">=</span> <span class="m">3</span><span class="m">6</span><span class="m">0</span><span class="m">0</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMemoryCache</span> <span class="n">memoryCache</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ConcurrentDictionary</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">,</span> <span class="n">SemaphoreSlim</span><span class="p">&gt;</span> <span class="n">locks</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ConcurrentDictionary</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">,</span> <span class="n">SemaphoreSlim</span><span class="p">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">SettingsStore</span><span class="p">(</span><span class="n">IMemoryCache</span> <span class="n">memoryCache</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">memoryCache</span> <span class="p">=</span> <span class="n">memoryCache</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Settings</span><span class="p">&gt;</span> <span class="n">GetSettingsAsync</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Normal lock doesn&#39;t work in async code
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="p">!</span><span class="n">memoryCache</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span> <span class="k">out</span> <span class="n">Settings</span> <span class="n">settings</span><span class="p">)</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">SemaphoreSlim</span> <span class="n">certLock</span> <span class="p">=</span> <span class="n">locks</span><span class="p">.</span><span class="n">GetOrAdd</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span> <span class="n">k</span> <span class="p">=</span><span class="p">&gt;</span> <span class="k">new</span> <span class="n">SemaphoreSlim</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
                <span class="k">await</span> <span class="n">certLock</span><span class="p">.</span><span class="n">WaitAsync</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="p">!</span><span class="n">memoryCache</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span> <span class="k">out</span> <span class="n">settings</span><span class="p">)</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="c1">// This method is not implemented because it can be anything.
</span><span class="c1"></span>                        <span class="c1">// The main part is that you want to cache an object.
</span><span class="c1"></span>                        <span class="n">settings</span> <span class="p">=</span> <span class="k">await</span> <span class="n">GetSettingsFromRemoteLocation</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
                        <span class="n">memoryCache</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">GetMemoryCacheEntryOptions</span><span class="p">(</span><span class="n">refreshTimeInSeconds</span><span class="p">)</span><span class="p">)</span><span class="p">;</span> <span class="c1">// 1 hour
</span><span class="c1"></span>                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">finally</span>
                <span class="p">{</span>
                    <span class="n">certLock</span><span class="p">.</span><span class="n">Release</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">settings</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">MemoryCacheEntryOptions</span> <span class="n">GetMemoryCacheEntryOptions</span><span class="p">(</span><span class="kt">int</span> <span class="n">expireInSeconds</span> <span class="p">=</span> <span class="m">3</span><span class="m">6</span><span class="m">0</span><span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">expirationTime</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">AddSeconds</span><span class="p">(</span><span class="n">expireInSeconds</span><span class="p">)</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">expirationToken</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CancellationChangeToken</span><span class="p">(</span>
                <span class="k">new</span> <span class="n">CancellationTokenSource</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="n">expireInSeconds</span> <span class="p">+</span> <span class="p">.</span><span class="m">0</span><span class="m">1</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="n">Token</span><span class="p">)</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">options</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryCacheEntryOptions</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
            <span class="n">options</span><span class="p">.</span><span class="n">SetAbsoluteExpiration</span><span class="p">(</span><span class="n">expirationTime</span><span class="p">)</span><span class="p">;</span>
            <span class="n">options</span><span class="p">.</span><span class="n">AddExpirationToken</span><span class="p">(</span><span class="n">expirationToken</span><span class="p">)</span><span class="p">;</span>

            <span class="n">options</span><span class="p">.</span><span class="n">PostEvictionCallbacks</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">PostEvictionCallbackRegistration</span><span class="p">(</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">EvictionCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="p">=</span><span class="p">=</span> <span class="n">EvictionReason</span><span class="p">.</span><span class="n">TokenExpired</span> <span class="p">|</span><span class="p">|</span> <span class="n">reason</span> <span class="p">=</span><span class="p">=</span> <span class="n">EvictionReason</span><span class="p">.</span><span class="n">Expired</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="c1">// If newValue is not null - update, otherwise just refresh the old value
</span><span class="c1"></span>                        <span class="c1">// The condition by which you decide to update or refresh the data depends entirely on you
</span><span class="c1"></span>                        <span class="c1">// If you want a cache object that will never expire you can just make the following call:
</span><span class="c1"></span>                        <span class="c1">// memoryCache.Set(key, value, GetMemoryCacheEntryOptions(expireInSeconds));
</span><span class="c1"></span>                        <span class="kt">var</span> <span class="n">newValue</span> <span class="p">=</span> <span class="k">await</span> <span class="n">GetSettingsFromRemoteLocation</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">newValue</span> <span class="p">!</span><span class="p">=</span> <span class="k">null</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">memoryCache</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">newValue</span><span class="p">,</span> <span class="n">GetMemoryCacheEntryOptions</span><span class="p">(</span><span class="n">expireInSeconds</span><span class="p">)</span><span class="p">)</span><span class="p">;</span> <span class="c1">// 1 hour
</span><span class="c1"></span>                        <span class="p">}</span>
                        <span class="k">else</span>
                        <span class="p">{</span>
                            <span class="n">memoryCache</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">GetMemoryCacheEntryOptions</span><span class="p">(</span><span class="n">expireInSeconds</span><span class="p">)</span><span class="p">)</span><span class="p">;</span> <span class="c1">// 1 hour
</span><span class="c1"></span>                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span><span class="p">)</span><span class="p">;</span>

            <span class="k">return</span> <span class="n">options</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Here we have 2 interesting behaviors we should take into consideration. Why do we need to use a cancellation token, and why won't the <strong><code>EvictionCallback</code></strong> execute after 1 hour without explicitly setting said token.</p>
<ul>
<li>
<p><a href="https://github.com/aspnet/Caching/issues/248">No background thread that actively scans the expiration</a>. This means we have to trigger the eviction/expiration ourselves.</p>
</li>
<li>
<p><a href="https://stackoverflow.com/a/47949111/2265179">We can trigger an expiration with the help of a CancellationToken</a></p>
</li>
</ul>
<p>To prove this to you I'll provide another pair of tests</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Caching.Memory</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Primitives</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UnitTesting</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">FooBar.Tests</span>
<span class="p">{</span>
<span class="na">    [TestClass]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MemoryCacheTests</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="n">IMemoryCache</span> <span class="n">CreateCache</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">MemoryCache</span><span class="p">(</span><span class="k">new</span> <span class="n">MemoryCacheOptions</span><span class="p">(</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ExpirationScanFrequency</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TimeSpan</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
            <span class="p">}</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
<span class="na">
</span><span class="na">        [TestMethod]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">ExpireAndReAddFromCallbackWorks</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">cache</span> <span class="p">=</span> <span class="n">CreateCache</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">initialValue</span> <span class="p">=</span> <span class="s">&#34;I&#39;m a value&#34;</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">newValue</span> <span class="p">=</span> <span class="s">&#34;I&#39;m the refreshed value&#34;</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">key</span> <span class="p">=</span> <span class="s">&#34;myKey&#34;</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">refreshCounter</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">options</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryCacheEntryOptions</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
            <span class="n">options</span><span class="p">.</span><span class="n">SetAbsoluteExpiration</span><span class="p">(</span><span class="k">new</span> <span class="n">TimeSpan</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
            <span class="n">options</span><span class="p">.</span><span class="n">PostEvictionCallbacks</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">PostEvictionCallbackRegistration</span><span class="p">(</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">EvictionCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">subValue</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="p">=</span><span class="p">=</span> <span class="n">EvictionReason</span><span class="p">.</span><span class="n">Expired</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">cache</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">newValue</span><span class="p">)</span><span class="p">;</span>
                        <span class="n">refreshCounter</span><span class="p">+</span><span class="p">+</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span><span class="p">)</span><span class="p">;</span>

            <span class="n">cache</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">initialValue</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span><span class="p">;</span>

            <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">6</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

            <span class="c1">// Any activity on the cache (Get, Set, Remove) can trigger a background scan for expired items.
</span><span class="c1"></span>            <span class="c1">// There&#39;s no background thread that scans the cache for expired times
</span><span class="c1"></span>            <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">cache</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="p">;</span>

            <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

            <span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">refreshCounter</span> <span class="p">&gt;</span><span class="p">=</span> <span class="m">1</span><span class="p">)</span><span class="p">;</span>
            <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">newValue</span><span class="p">,</span> <span class="n">cache</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
<span class="na">
</span><span class="na">        [TestMethod]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">TokenExpireAndReAddFromCallbackWorks</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">cache</span> <span class="p">=</span> <span class="n">CreateCache</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">initialValue</span> <span class="p">=</span> <span class="s">&#34;I&#39;m a value&#34;</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">newValue</span> <span class="p">=</span> <span class="s">&#34;I&#39;m the refreshed value&#34;</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">key</span> <span class="p">=</span> <span class="s">&#34;myKey&#34;</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">refreshCounter</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

            <span class="kt">int</span> <span class="n">expirationSeconds</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">expirationTime</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">AddSeconds</span><span class="p">(</span><span class="n">expirationSeconds</span><span class="p">)</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">expirationToken</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CancellationChangeToken</span><span class="p">(</span>
                <span class="k">new</span> <span class="n">CancellationTokenSource</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="n">expirationSeconds</span> <span class="p">+</span> <span class="p">.</span><span class="m">0</span><span class="m">1</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="n">Token</span><span class="p">)</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">options</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryCacheEntryOptions</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
            <span class="n">options</span><span class="p">.</span><span class="n">SetAbsoluteExpiration</span><span class="p">(</span><span class="n">expirationTime</span><span class="p">)</span><span class="p">;</span>
            <span class="n">options</span><span class="p">.</span><span class="n">AddExpirationToken</span><span class="p">(</span><span class="n">expirationToken</span><span class="p">)</span><span class="p">;</span>
            <span class="n">options</span><span class="p">.</span><span class="n">PostEvictionCallbacks</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">PostEvictionCallbackRegistration</span><span class="p">(</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">EvictionCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">subValue</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="p">=</span><span class="p">=</span> <span class="n">EvictionReason</span><span class="p">.</span><span class="n">TokenExpired</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">cache</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">newValue</span><span class="p">)</span><span class="p">;</span>
                        <span class="n">refreshCounter</span><span class="p">+</span><span class="p">+</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span><span class="p">)</span><span class="p">;</span>

            <span class="n">cache</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">initialValue</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span><span class="p">;</span>

            <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">6</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

            <span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">refreshCounter</span> <span class="p">&gt;</span><span class="p">=</span> <span class="m">1</span><span class="p">)</span><span class="p">;</span>
            <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">newValue</span><span class="p">,</span> <span class="n">cache</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>So that's basically it! Now we have our auto refreshing cache! There's a lot that we can improve. You have to be careful who has access to the keys for your specific object and a million other considerations. Caching is a steep hill to climb, but I hope you found this blog post informative in some capacity!</p>
<p>I've used both implementations for some heavy objects that don't change often in production environments and they've been doing their job pretty well so far!</p>

    </div>

    <div>
      
      <h2 id="caching-is-hard">Caching is hard</h2>
<p>On a bright sunny day while you're working on your awesome project you catch a glimpse of something. You bring yourself closer to the monitor and begin meticulously examining your code. What you find brings you feelings of disgust and shame! You've been calling an API retrieving data you need over and over again even though said data hardly changes!</p>
<p>Being the smart and responsible engineer that you are, you decide to rectify your mistake immediately. You think to yourself</p>
<blockquote>
<p>&quot;OK, I'll just implement caching around that piece of data and I'm done!&rdquo;</p>
</blockquote>
<p>Not so fast! Little do you know that you're opening the gates of your own small personal hell!</p>
<h2 id="caching-in-net">Caching in .NET</h2>
<p>The little story above is a <em>slight</em> exaggeration, but caching is indeed a touchy subject. It's a nice performance boost when done right, but it can also lead you to a dark path filled with scary monsters and unforeseen problems.</p>
<p>There are many articles written on caching in .NET, you should read the official docs and perhaps other articles written by the good people on the Internet.</p>
<p>This article however will deal with a very specific caching problem. How can you implement a cache that is refreshing itself after a specific amount of time with the following characteristics:</p>
<ul>
<li>Thread safety</li>
<li>Not getting any cache misses (even if that means we're returning stale data)</li>
</ul>
<p>If that's what you need, keep on reading!</p>
<h2 id="implementation-with-memorycache-in-net-framework">Implementation with MemoryCache in .NET Framework</h2>
<p>Let's start with the simple stuff. We want to perform some basic CRUD operations on our cache - saving data to it, getting our cached objects and potentially deleting our data. The best way to do it is to define an interface.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System.Runtime.Caching</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">FooBar.Caching</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">interface</span> <span class="n">IMemoryAutoRefreshCache</span>
    <span class="p">{</span>
        <span class="n">T</span> <span class="n">GetById</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">)</span><span class="p">;</span>
        <span class="k">void</span> <span class="n">Save</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">,</span> <span class="n">T</span> <span class="n">cacheObj</span><span class="p">,</span> <span class="n">CacheItemPolicy</span> <span class="n">refreshPolicy</span><span class="p">)</span><span class="p">;</span>
        <span class="k">void</span> <span class="n">Remove</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>These are the methods I'm going to use to illustrate my example. Depending on your use case you can have a lot more of them doing various things to your cache, but for my case those are enough. The point I want you to focus on here is the <strong><code>CacheItemPolicy</code></strong> we can set during the Save.</p>
<p>Now that we have our interface we can also implement it in a new class</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System.Runtime.Caching</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">FooBar.Caching</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MemoryAutoRefreshCache</span> <span class="p">:</span> <span class="n">IMemoryAutoRefreshCache</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">MemoryCache</span> <span class="n">memoryCache</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">MemoryAutoRefreshCache</span><span class="p">(</span><span class="n">MemoryCache</span> <span class="n">memoryCache</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">memoryCache</span> <span class="p">=</span> <span class="n">memoryCache</span> <span class="p">?</span><span class="p">?</span> <span class="n">MemoryCache</span><span class="p">.</span><span class="n">Default</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">T</span> <span class="n">GetById</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="k">value</span> <span class="p">=</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="n">memoryCache</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">value</span> <span class="p">=</span><span class="p">=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">default</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="k">value</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="n">Save</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">,</span> <span class="n">T</span> <span class="n">result</span><span class="p">,</span> <span class="n">CacheItemPolicy</span> <span class="n">refreshPolicy</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">memoryCache</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">refreshPolicy</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="n">Remove</span><span class="p">(</span><span class="kt">string</span> <span class="n">id</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">memoryCache</span><span class="p">.</span><span class="n">Remove</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Nothing out of the ordinary here. I want to bring your attention to our <strong><code>Save</code></strong> method one more time and the CacheItemPolicy. The summary of <strong><code>CacheItemPolicy</code></strong> states:</p>
<blockquote>
<p>Represents a set of eviction and expiration details for a specific cache entry.</p>
</blockquote>
<p>Inside the <strong><code>CacheItemPolicy</code></strong> we have two callbacks which will give us everything we need to accomplish our task.</p>
<ul>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.caching.cacheentryremovedcallback?view=netframework-4.8"><strong><code>RemovedCallback</code></strong></a> - Occurs <strong><em>after</em></strong> the item has been removed</li>
<li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.runtime.caching.cacheentryupdatecallback?view=netframework-4.8"><strong><code>UpdateCallback</code></strong></a> - Occurs <strong><em>before</em></strong> the item is removed</li>
</ul>
<p>As you can imagine we'll use the <strong><code>UpdateCallback</code></strong> in our case.</p>
<p>So let's see how an implementation of this auto refreshing cache will look like!</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Caching</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">FooBar.Caching</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">FooBar.Services.Configuration</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">ConfigurationProvider</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMemoryAutoRefreshCache</span> <span class="n">localCache</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">cacheKey</span> <span class="p">=</span> <span class="s">&#34;myAwesomeCacheKey&#34;</span><span class="p">;</span>

        <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">object</span> <span class="n">_lock</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">object</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">ConfigurationProvider</span><span class="p">(</span><span class="n">ILocalAutoRefreshCache</span> <span class="n">localCache</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">localCache</span> <span class="p">=</span> <span class="n">localCache</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">Configuration</span> <span class="n">GetConfiguration</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">cachedConfig</span> <span class="p">=</span> <span class="n">localCache</span><span class="p">.</span><span class="n">GetById</span><span class="p">&lt;</span><span class="n">Configuration</span><span class="p">&gt;</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">)</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cachedConfig</span> <span class="p">!</span><span class="p">=</span> <span class="k">null</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">cachedConfig</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">lock</span> <span class="p">(</span><span class="n">_lock</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Check to see if anyone wrote in the cache while we&#39;re waiting for our turn
</span><span class="c1"></span>                <span class="n">cachedConfig</span> <span class="p">=</span> <span class="n">localCache</span><span class="p">.</span><span class="n">GetById</span><span class="p">&lt;</span><span class="n">Configuration</span><span class="p">&gt;</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">)</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cachedConfig</span> <span class="p">!</span><span class="p">=</span> <span class="k">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="n">cachedConfig</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="c1">// This method is not implemented because it can be anything. The main part is that you want to cache an object.
</span><span class="c1"></span>                <span class="n">cachedConfig</span> <span class="p">=</span> <span class="n">GetConfigurationFromRemoteLocation</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span><span class="p">;</span>
                <span class="kt">int</span> <span class="n">refreshTimeInSeconds</span> <span class="p">=</span> <span class="m">3</span><span class="m">6</span><span class="m">0</span><span class="m">0</span><span class="p">;</span> <span class="c1">// 1 hour
</span><span class="c1"></span>                <span class="n">localCache</span><span class="p">.</span><span class="n">Save</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span> <span class="n">cachedConfig</span><span class="p">,</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="n">refreshTimeInSeconds</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

                <span class="k">return</span> <span class="n">cachedConfig</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">CacheItemPolicy</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="kt">int</span> <span class="n">refreshInterval</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CacheItemPolicy</span>
            <span class="p">{</span>
                <span class="c1">// This is where the magic happens
</span><span class="c1"></span>                <span class="c1">// The UpdateCallback will be called before our object is removed from the cache
</span><span class="c1"></span>                <span class="n">UpdateCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">CacheEntryUpdateArguments</span> <span class="n">args</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">RemovedReason</span> <span class="p">=</span><span class="p">=</span> <span class="n">CacheEntryRemovedReason</span><span class="p">.</span><span class="n">Expired</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="kt">var</span> <span class="n">cacheKey</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Key</span><span class="p">;</span>

                        <span class="c1">// Get current cached value
</span><span class="c1"></span>                        <span class="kt">var</span> <span class="n">currentCachedEntity</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Source</span><span class="p">[</span><span class="n">cacheKey</span><span class="p">]</span> <span class="k">as</span> <span class="n">Configuration</span><span class="p">;</span>

                        <span class="c1">// Get the potentially new data
</span><span class="c1"></span>                        <span class="kt">var</span> <span class="n">newEntity</span> <span class="p">=</span> <span class="n">GetConfigurationFromRemoteLocation</span><span class="p">(</span><span class="n">provider</span><span class="p">)</span><span class="p">;</span>

                        <span class="c1">// If new is not null - update, otherwise just refresh the old value
</span><span class="c1"></span>                        <span class="c1">// The condition by which you decide to update or refresh the data depends entirely on you
</span><span class="c1"></span>                        <span class="k">if</span> <span class="p">(</span><span class="n">newEntity</span> <span class="p">!</span><span class="p">=</span> <span class="k">null</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="kt">var</span> <span class="n">updatedEntity</span> <span class="p">=</span> <span class="n">newEntity</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItem</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CacheItem</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span> <span class="n">updatedEntity</span><span class="p">)</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItemPolicy</span> <span class="p">=</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span>
                        <span class="p">{</span>
                            <span class="kt">var</span> <span class="n">updatedEntity</span> <span class="p">=</span> <span class="n">currentCachedEntity</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItem</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CacheItem</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span> <span class="n">updatedEntity</span><span class="p">)</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItemPolicy</span> <span class="p">=</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span><span class="p">,</span>
                <span class="n">AbsoluteExpiration</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">.</span><span class="n">AddSeconds</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span><span class="p">,</span>
            <span class="p">}</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>So there you go! Now you can refresh, update or invalidate your cache every hour depending on the behavior you desire!</p>
<h3 id="bonus">Bonus</h3>
<p>As a bonus you can read on the interesting thing that happens when you put <strong><code>AbsoluteExpiration</code></strong> below 20 seconds <a href="https://stackoverflow.com/questions/12630168/memorycache-absoluteexpiration-acting-strange">here</a>.</p>
<p>Also it's important to note that items can expire some time after the AbsoluteExpiration, there's no guarantee that they'll expire right on the spot. Here are two tests confirming that (I know we shouldn't test code that isn't ours, but it's fun!)</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">FooBar.Caching</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">NUnit.Framework</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.Caching</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">FooBar.Caching.UnitTests</span>
<span class="p">{</span>
<span class="na">    [TestFixture]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MemoryAutoRefreshCacheTests</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="n">MemoryAutoRefreshCache</span> <span class="n">subject</span><span class="p">;</span>
        <span class="k">private</span> <span class="kt">int</span> <span class="n">updateItemCounter</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
<span class="na">
</span><span class="na">        [SetUp]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="n">Setup</span><span class="p">(</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span> <span class="n">subject</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryAutoRefreshCache</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="na">
</span><span class="na">        [Test]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">VerifyUpdateCallback_LocalMemoryCache</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">updateItemCounter</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

            <span class="n">subject</span><span class="p">.</span><span class="n">Save</span><span class="p">(</span><span class="s">$&#34;key&#34;</span><span class="p">,</span> <span class="s">&#34;value&#34;</span><span class="p">,</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

            <span class="c1">// The item can be expired between 0 and 30 seconds after expiration time
</span><span class="c1"></span>            <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">3</span><span class="m">2</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

            <span class="c1">// Test that the update callback was invoked at least once
</span><span class="c1"></span>            <span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">updateItemCounter</span> <span class="p">&gt;</span><span class="p">=</span> <span class="m">1</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
<span class="na">
</span><span class="na">        [Test]</span>
        <span class="k">public</span> <span class="k">void</span> <span class="n">VerifyUpdateCallbackReturnsDuringRefresh_LocalMemoryCache</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">updateItemCounter</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

            <span class="kt">string</span> <span class="n">key</span> <span class="p">=</span> <span class="s">&#34;key&#34;</span><span class="p">;</span>
            <span class="kt">string</span> <span class="k">value</span> <span class="p">=</span> <span class="s">&#34;value&#34;</span><span class="p">;</span>

            <span class="n">subject</span><span class="p">.</span><span class="n">Save</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">GetPolicyWithDelay</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

            <span class="c1">// The item can be expired between 0 and 30 seconds after expiration time
</span><span class="c1"></span>            <span class="kt">var</span> <span class="n">start</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>

            <span class="k">do</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">cachedItem</span> <span class="p">=</span> <span class="n">subject</span><span class="p">.</span><span class="n">GetById</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span><span class="p">(</span><span class="s">&#34;key&#34;</span><span class="p">)</span><span class="p">;</span>
                <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="k">value</span><span class="p">,</span> <span class="n">cachedItem</span><span class="p">)</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">start</span><span class="p">.</span><span class="n">AddSeconds</span><span class="p">(</span><span class="m">4</span><span class="m">0</span><span class="p">)</span> <span class="p">&gt;</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">)</span><span class="p">;</span>

            <span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">updateItemCounter</span> <span class="p">&gt;</span><span class="p">=</span> <span class="m">1</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="kt">string</span> <span class="n">AddKeys</span><span class="p">(</span><span class="kt">string</span> <span class="n">key</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">updateItemCounter</span><span class="p">+</span><span class="p">+</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">key</span> <span class="p">+</span> <span class="n">key</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="k">void</span> <span class="n">UpdateCounter</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">updateItemCounter</span><span class="p">+</span><span class="p">+</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">CacheItemPolicy</span> <span class="n">GetPolicyWithDelay</span><span class="p">(</span><span class="kt">double</span> <span class="n">refreshInterval</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CacheItemPolicy</span>
            <span class="p">{</span>
                <span class="n">UpdateCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">CacheEntryUpdateArguments</span> <span class="n">args</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">RemovedReason</span> <span class="p">=</span><span class="p">=</span> <span class="n">CacheEntryRemovedReason</span><span class="p">.</span><span class="n">Expired</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">Thread</span><span class="p">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">2</span><span class="m">0</span><span class="m">0</span><span class="m">0</span><span class="p">)</span><span class="p">;</span>
                        <span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Key</span><span class="p">;</span>

                        <span class="c1">// Get current cached value
</span><span class="c1"></span>                        <span class="kt">var</span> <span class="n">currentCachedEntity</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Source</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="k">as</span> <span class="kt">string</span><span class="p">;</span>
                        <span class="n">UpdateCounter</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

                        <span class="kt">var</span> <span class="n">newEntity</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Source</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="p">;</span>

                        <span class="c1">// If new is not null - update, otherwise just refresh the old value
</span><span class="c1"></span>                        <span class="k">if</span> <span class="p">(</span><span class="n">newEntity</span> <span class="p">!</span><span class="p">=</span> <span class="k">null</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="kt">var</span> <span class="n">updatedEntity</span> <span class="p">=</span> <span class="n">newEntity</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItem</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CacheItem</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">updatedEntity</span><span class="p">)</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItemPolicy</span> <span class="p">=</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span>
                        <span class="p">{</span>
                            <span class="kt">var</span> <span class="n">updatedEntity</span> <span class="p">=</span> <span class="n">currentCachedEntity</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItem</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CacheItem</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">updatedEntity</span><span class="p">)</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItemPolicy</span> <span class="p">=</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span><span class="p">;</span>
                        <span class="p">}</span>

                    <span class="p">}</span>
                <span class="p">}</span><span class="p">,</span>
                <span class="n">AbsoluteExpiration</span> <span class="p">=</span> <span class="n">DateTimeOffset</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">.</span><span class="n">AddSeconds</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span>
            <span class="p">}</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">CacheItemPolicy</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="kt">double</span> <span class="n">refreshInterval</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CacheItemPolicy</span>
            <span class="p">{</span>
                <span class="n">UpdateCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">CacheEntryUpdateArguments</span> <span class="n">args</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">RemovedReason</span> <span class="p">=</span><span class="p">=</span> <span class="n">CacheEntryRemovedReason</span><span class="p">.</span><span class="n">Expired</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Key</span><span class="p">;</span>

                        <span class="c1">// Get current cached value
</span><span class="c1"></span>                        <span class="kt">var</span> <span class="n">currentCachedEntity</span> <span class="p">=</span> <span class="n">args</span><span class="p">.</span><span class="n">Source</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="k">as</span> <span class="kt">string</span><span class="p">;</span>

                        <span class="kt">var</span> <span class="n">newEntity</span> <span class="p">=</span> <span class="n">AddKeys</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="p">;</span>

                        <span class="c1">// If new is not null - update, otherwise just refresh the old value
</span><span class="c1"></span>                        <span class="k">if</span> <span class="p">(</span><span class="n">newEntity</span> <span class="p">!</span><span class="p">=</span> <span class="k">null</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="kt">var</span> <span class="n">updatedEntity</span> <span class="p">=</span> <span class="n">newEntity</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItem</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CacheItem</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">updatedEntity</span><span class="p">)</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItemPolicy</span> <span class="p">=</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">else</span>
                        <span class="p">{</span>
                            <span class="kt">var</span> <span class="n">updatedEntity</span> <span class="p">=</span> <span class="n">currentCachedEntity</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItem</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CacheItem</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">updatedEntity</span><span class="p">)</span><span class="p">;</span>
                            <span class="n">args</span><span class="p">.</span><span class="n">UpdatedCacheItemPolicy</span> <span class="p">=</span> <span class="n">GetPolicy</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span><span class="p">;</span>
                        <span class="p">}</span>

                    <span class="p">}</span>
                <span class="p">}</span><span class="p">,</span>
                <span class="n">SlidingExpiration</span> <span class="p">=</span> <span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="n">refreshInterval</span><span class="p">)</span><span class="p">,</span>
            <span class="p">}</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h2 id="implementation-with-imemorycache-in-net-core">Implementation with IMemoryCache in .NET Core</h2>
<p>I have a strong feeling a lot of people will come to read this article for the part that follows&hellip; Who cares about .NET Framework, amirite?! It's all about .NET Core nowadays, son!</p>
<p>I'd be lying if I didn't say that I prefer the .NET Core implementation. But I digress. Let's stay on the issue at hand - implementing an auto refreshing cache.</p>
<p>We still have access to <strong><code>MemoryCache</code></strong> in .NET Core. However it only provides a callback which will execute <strong><em>after</em></strong> an item has been <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.caching.memory.memorycacheentryoptions.postevictioncallbacks?view=aspnetcore-2.2#Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_PostEvictionCallbacks">removed</a>. That doesn't matter for our use case. Remember what we said at the start. We don't care if we get stale data as long as there are no cache misses! To achieve the same thing we did in the previous section we are going to use a shiny new interface called <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.extensions.caching.memory.imemorycache?view=aspnetcore-2.2"><strong><code>IMemoryCache</code></strong></a>. And guess what! It's provided by Microsoft too!</p>
<p>The code is more or less the same with some differences when it comes to the locking. This time we're performing operations inside an async method so we can't use a regular lock. For the sake of completeness I'll provide the full implementation + tests and gotchas after.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Concurrent</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Caching.Memory</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">FooBar.Providers</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">SettingsStore</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">cacheKey</span> <span class="p">=</span> <span class="s">&#34;FooBarPrivateKey&#34;</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">refreshTimeInSeconds</span> <span class="p">=</span> <span class="m">3</span><span class="m">6</span><span class="m">0</span><span class="m">0</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">IMemoryCache</span> <span class="n">memoryCache</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">readonly</span> <span class="n">ConcurrentDictionary</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">,</span> <span class="n">SemaphoreSlim</span><span class="p">&gt;</span> <span class="n">locks</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ConcurrentDictionary</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">,</span> <span class="n">SemaphoreSlim</span><span class="p">&gt;</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

        <span class="k">public</span> <span class="n">SettingsStore</span><span class="p">(</span><span class="n">IMemoryCache</span> <span class="n">memoryCache</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="n">memoryCache</span> <span class="p">=</span> <span class="n">memoryCache</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">Settings</span><span class="p">&gt;</span> <span class="n">GetSettingsAsync</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Normal lock doesn&#39;t work in async code
</span><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="p">!</span><span class="n">memoryCache</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span> <span class="k">out</span> <span class="n">Settings</span> <span class="n">settings</span><span class="p">)</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">SemaphoreSlim</span> <span class="n">certLock</span> <span class="p">=</span> <span class="n">locks</span><span class="p">.</span><span class="n">GetOrAdd</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span> <span class="n">k</span> <span class="p">=</span><span class="p">&gt;</span> <span class="k">new</span> <span class="n">SemaphoreSlim</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
                <span class="k">await</span> <span class="n">certLock</span><span class="p">.</span><span class="n">WaitAsync</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="p">!</span><span class="n">memoryCache</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span> <span class="k">out</span> <span class="n">settings</span><span class="p">)</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="c1">// This method is not implemented because it can be anything.
</span><span class="c1"></span>                        <span class="c1">// The main part is that you want to cache an object.
</span><span class="c1"></span>                        <span class="n">settings</span> <span class="p">=</span> <span class="k">await</span> <span class="n">GetSettingsFromRemoteLocation</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
                        <span class="n">memoryCache</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">,</span> <span class="n">settings</span><span class="p">,</span> <span class="n">GetMemoryCacheEntryOptions</span><span class="p">(</span><span class="n">refreshTimeInSeconds</span><span class="p">)</span><span class="p">)</span><span class="p">;</span> <span class="c1">// 1 hour
</span><span class="c1"></span>                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">finally</span>
                <span class="p">{</span>
                    <span class="n">certLock</span><span class="p">.</span><span class="n">Release</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">settings</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="n">MemoryCacheEntryOptions</span> <span class="n">GetMemoryCacheEntryOptions</span><span class="p">(</span><span class="kt">int</span> <span class="n">expireInSeconds</span> <span class="p">=</span> <span class="m">3</span><span class="m">6</span><span class="m">0</span><span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">expirationTime</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">AddSeconds</span><span class="p">(</span><span class="n">expireInSeconds</span><span class="p">)</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">expirationToken</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CancellationChangeToken</span><span class="p">(</span>
                <span class="k">new</span> <span class="n">CancellationTokenSource</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="n">expireInSeconds</span> <span class="p">+</span> <span class="p">.</span><span class="m">0</span><span class="m">1</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="n">Token</span><span class="p">)</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">options</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryCacheEntryOptions</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
            <span class="n">options</span><span class="p">.</span><span class="n">SetAbsoluteExpiration</span><span class="p">(</span><span class="n">expirationTime</span><span class="p">)</span><span class="p">;</span>
            <span class="n">options</span><span class="p">.</span><span class="n">AddExpirationToken</span><span class="p">(</span><span class="n">expirationToken</span><span class="p">)</span><span class="p">;</span>

            <span class="n">options</span><span class="p">.</span><span class="n">PostEvictionCallbacks</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">PostEvictionCallbackRegistration</span><span class="p">(</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">EvictionCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="p">=</span><span class="p">=</span> <span class="n">EvictionReason</span><span class="p">.</span><span class="n">TokenExpired</span> <span class="p">|</span><span class="p">|</span> <span class="n">reason</span> <span class="p">=</span><span class="p">=</span> <span class="n">EvictionReason</span><span class="p">.</span><span class="n">Expired</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="c1">// If newValue is not null - update, otherwise just refresh the old value
</span><span class="c1"></span>                        <span class="c1">// The condition by which you decide to update or refresh the data depends entirely on you
</span><span class="c1"></span>                        <span class="c1">// If you want a cache object that will never expire you can just make the following call:
</span><span class="c1"></span>                        <span class="c1">// memoryCache.Set(key, value, GetMemoryCacheEntryOptions(expireInSeconds));
</span><span class="c1"></span>                        <span class="kt">var</span> <span class="n">newValue</span> <span class="p">=</span> <span class="k">await</span> <span class="n">GetSettingsFromRemoteLocation</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">newValue</span> <span class="p">!</span><span class="p">=</span> <span class="k">null</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">memoryCache</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">newValue</span><span class="p">,</span> <span class="n">GetMemoryCacheEntryOptions</span><span class="p">(</span><span class="n">expireInSeconds</span><span class="p">)</span><span class="p">)</span><span class="p">;</span> <span class="c1">// 1 hour
</span><span class="c1"></span>                        <span class="p">}</span>
                        <span class="k">else</span>
                        <span class="p">{</span>
                            <span class="n">memoryCache</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">value</span><span class="p">,</span> <span class="n">GetMemoryCacheEntryOptions</span><span class="p">(</span><span class="n">expireInSeconds</span><span class="p">)</span><span class="p">)</span><span class="p">;</span> <span class="c1">// 1 hour
</span><span class="c1"></span>                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span><span class="p">)</span><span class="p">;</span>

            <span class="k">return</span> <span class="n">options</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Here we have 2 interesting behaviors we should take into consideration. Why do we need to use a cancellation token, and why won't the <strong><code>EvictionCallback</code></strong> execute after 1 hour without explicitly setting said token.</p>
<ul>
<li>
<p><a href="https://github.com/aspnet/Caching/issues/248">No background thread that actively scans the expiration</a>. This means we have to trigger the eviction/expiration ourselves.</p>
</li>
<li>
<p><a href="https://stackoverflow.com/a/47949111/2265179">We can trigger an expiration with the help of a CancellationToken</a></p>
</li>
</ul>
<p>To prove this to you I'll provide another pair of tests</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Caching.Memory</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.Extensions.Primitives</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.VisualStudio.TestTools.UnitTesting</span><span class="p">;</span>

<span class="k">namespace</span> <span class="nn">FooBar.Tests</span>
<span class="p">{</span>
<span class="na">    [TestClass]</span>
    <span class="k">public</span> <span class="k">class</span> <span class="nc">MemoryCacheTests</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="n">IMemoryCache</span> <span class="n">CreateCache</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">MemoryCache</span><span class="p">(</span><span class="k">new</span> <span class="n">MemoryCacheOptions</span><span class="p">(</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ExpirationScanFrequency</span> <span class="p">=</span> <span class="k">new</span> <span class="n">TimeSpan</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
            <span class="p">}</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
<span class="na">
</span><span class="na">        [TestMethod]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">ExpireAndReAddFromCallbackWorks</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">cache</span> <span class="p">=</span> <span class="n">CreateCache</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">initialValue</span> <span class="p">=</span> <span class="s">&#34;I&#39;m a value&#34;</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">newValue</span> <span class="p">=</span> <span class="s">&#34;I&#39;m the refreshed value&#34;</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">key</span> <span class="p">=</span> <span class="s">&#34;myKey&#34;</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">refreshCounter</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">options</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryCacheEntryOptions</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
            <span class="n">options</span><span class="p">.</span><span class="n">SetAbsoluteExpiration</span><span class="p">(</span><span class="k">new</span> <span class="n">TimeSpan</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
            <span class="n">options</span><span class="p">.</span><span class="n">PostEvictionCallbacks</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">PostEvictionCallbackRegistration</span><span class="p">(</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">EvictionCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">subValue</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="p">=</span><span class="p">=</span> <span class="n">EvictionReason</span><span class="p">.</span><span class="n">Expired</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">cache</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">newValue</span><span class="p">)</span><span class="p">;</span>
                        <span class="n">refreshCounter</span><span class="p">+</span><span class="p">+</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span><span class="p">)</span><span class="p">;</span>

            <span class="n">cache</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">initialValue</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span><span class="p">;</span>

            <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">6</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

            <span class="c1">// Any activity on the cache (Get, Set, Remove) can trigger a background scan for expired items.
</span><span class="c1"></span>            <span class="c1">// There&#39;s no background thread that scans the cache for expired times
</span><span class="c1"></span>            <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">cache</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="p">;</span>

            <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

            <span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">refreshCounter</span> <span class="p">&gt;</span><span class="p">=</span> <span class="m">1</span><span class="p">)</span><span class="p">;</span>
            <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">newValue</span><span class="p">,</span> <span class="n">cache</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
<span class="na">
</span><span class="na">        [TestMethod]</span>
        <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">TokenExpireAndReAddFromCallbackWorks</span><span class="p">(</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">cache</span> <span class="p">=</span> <span class="n">CreateCache</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">initialValue</span> <span class="p">=</span> <span class="s">&#34;I&#39;m a value&#34;</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">newValue</span> <span class="p">=</span> <span class="s">&#34;I&#39;m the refreshed value&#34;</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">key</span> <span class="p">=</span> <span class="s">&#34;myKey&#34;</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">refreshCounter</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

            <span class="kt">int</span> <span class="n">expirationSeconds</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">expirationTime</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">AddSeconds</span><span class="p">(</span><span class="n">expirationSeconds</span><span class="p">)</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">expirationToken</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CancellationChangeToken</span><span class="p">(</span>
                <span class="k">new</span> <span class="n">CancellationTokenSource</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="n">expirationSeconds</span> <span class="p">+</span> <span class="p">.</span><span class="m">0</span><span class="m">1</span><span class="p">)</span><span class="p">)</span><span class="p">.</span><span class="n">Token</span><span class="p">)</span><span class="p">;</span>

            <span class="kt">var</span> <span class="n">options</span> <span class="p">=</span> <span class="k">new</span> <span class="n">MemoryCacheEntryOptions</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
            <span class="n">options</span><span class="p">.</span><span class="n">SetAbsoluteExpiration</span><span class="p">(</span><span class="n">expirationTime</span><span class="p">)</span><span class="p">;</span>
            <span class="n">options</span><span class="p">.</span><span class="n">AddExpirationToken</span><span class="p">(</span><span class="n">expirationToken</span><span class="p">)</span><span class="p">;</span>
            <span class="n">options</span><span class="p">.</span><span class="n">PostEvictionCallbacks</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">PostEvictionCallbackRegistration</span><span class="p">(</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">EvictionCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">subkey</span><span class="p">,</span> <span class="n">subValue</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="p">=</span><span class="p">&gt;</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="p">=</span><span class="p">=</span> <span class="n">EvictionReason</span><span class="p">.</span><span class="n">TokenExpired</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">cache</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">newValue</span><span class="p">)</span><span class="p">;</span>
                        <span class="n">refreshCounter</span><span class="p">+</span><span class="p">+</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span><span class="p">)</span><span class="p">;</span>

            <span class="n">cache</span><span class="p">.</span><span class="n">Set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">initialValue</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span><span class="p">;</span>

            <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="n">TimeSpan</span><span class="p">.</span><span class="n">FromSeconds</span><span class="p">(</span><span class="m">6</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

            <span class="n">Assert</span><span class="p">.</span><span class="n">IsTrue</span><span class="p">(</span><span class="n">refreshCounter</span> <span class="p">&gt;</span><span class="p">=</span> <span class="m">1</span><span class="p">)</span><span class="p">;</span>
            <span class="n">Assert</span><span class="p">.</span><span class="n">AreEqual</span><span class="p">(</span><span class="n">newValue</span><span class="p">,</span> <span class="n">cache</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>So that's basically it! Now we have our auto refreshing cache! There's a lot that we can improve. You have to be careful who has access to the keys for your specific object and a million other considerations. Caching is a steep hill to climb, but I hope you found this blog post informative in some capacity!</p>
<p>I've used both implementations for some heavy objects that don't change often in production environments and they've been doing their job pretty well so far!</p>

    </div>

    <footer>
      


      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "underscorehao" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      
    </footer>
  </article>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js" id="MathJax-script"></script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [
          ['$', '$'], ['\\(', '\\)']
        ],
        processEscapes: true,
        processEnvironments: true
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    };
  </script>
</section>

      </div>

      
  <footer class="footer">
    <section class="container">
      
      
        Â©
        
        2020
         Pavel Danov 
      
      
         Â· 
        Powered by <a href="https://gohugo.io/">Hugo</a> & <a href="https://github.com/luizdepra/hugo-coder/">Coder</a>.
      
      
    </section>
  </footer>

    </main>

    

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-106583563-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


    

  </body>

</html>
